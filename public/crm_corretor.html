<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ImobiPro | CRM Corretor</title>

  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ESTILOS CSS COMPLETOS (mantenha todo o CSS que você já tem) */
    :root{
      --bg0:#f8fafc;
      --bg1:#ffffff;
      --bg2:#f1f5f9;
      --card:#ffffff;
      --card2:#f8fafc;
      --stroke:#e2e8f0;
      --stroke2:#cbd5e1;

      --text:#1e293b;
      --muted:#64748b;

      --primary:#2563eb;
      --primary-light:#3b82f6;
      --primary-dark:#1d4ed8;
      --secondary:#0ea5e9;
      --accent:#f97316;

      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --info:#3b82f6;

      --shadow: 0 10px 40px rgba(0,0,0,.08);
      --shadow-lg: 0 20px 60px rgba(0,0,0,.12);
      --shadow-card: 0 4px 12px rgba(0,0,0,.05);

      --radius: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;

      --sbarW: 280px;

      --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-light));
      --gradient-secondary: linear-gradient(135deg, var(--secondary), #38bdf8);
    }

    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%}
    body{
      margin:0;
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: var(--bg0);
      line-height:1.6;
      overflow:hidden;
    }

    /* ====== LAYOUT ====== */
    .app{
      display:grid;
      grid-template-columns: var(--sbarW) 1fr;
      height:100%;
      width:100%;
      position:relative;
    }

    /* ====== SIDEBAR ====== */
    .sidebar{
      background: var(--bg1);
      border-right: 1px solid var(--stroke);
      padding:24px 20px;
      display:flex;
      flex-direction:column;
      box-shadow: var(--shadow-card);
      z-index:10;
    }
    
    .brand{
      display:flex; align-items:center; gap:12px;
      padding:16px;
      margin-bottom:24px;
      border-radius:var(--radius-lg);
      background: var(--gradient-primary);
      color:white;
      box-shadow: var(--shadow);
    }
    
    .brand .mark{
      width:48px; height:48px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.2);
      backdrop-filter: blur(10px);
    }
    
    .brand .mark i{font-size:22px}
    
    .brand .title{
      display:flex; flex-direction:column; line-height:1.2;
    }
    
    .brand .title strong{
      font-size:18px; 
      font-weight:700;
      letter-spacing:.2px;
    }
    
    .brand .title span{
      font-size:13px; 
      opacity:.9;
      font-weight:500;
    }

    .nav{
      flex:1;
      display:flex; flex-direction:column;
      gap:6px;
      margin-bottom:20px;
    }
    
    .nav button{
      width:100%;
      display:flex; align-items:center; gap:14px;
      padding:14px 16px;
      border-radius:var(--radius);
      border: 1px solid transparent;
      background: transparent;
      color: var(--text);
      cursor:pointer;
      transition: all .2s ease;
      font-weight:500;
      text-align:left;
      position:relative;
    }
    
    .nav button:hover{
      background: var(--card2);
      border-color: var(--stroke);
      transform: translateX(4px);
    }
    
    .nav button.active{
      background: var(--gradient-primary);
      color: white;
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }
    
    .nav button i{
      width:20px;
      font-size:16px;
    }
    
    .nav button span{
      flex:1;
      font-weight:500;
      letter-spacing:.2px;
      font-size:14px;
    }
    
    .nav button .badge{
      background: rgba(255,255,255,.9);
      color: var(--primary);
      padding:4px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      min-width:24px;
      text-align:center;
    }
    
    .nav button.active .badge{
      background: white;
      color: var(--primary);
    }

    .sidebarFooter{
      margin-top:auto;
      padding-top:20px;
      border-top: 1px solid var(--stroke);
    }
    
    .planCard{
      padding:18px;
      border-radius:var(--radius-lg);
      background: var(--gradient-primary);
      color:white;
      margin-bottom:16px;
      box-shadow: var(--shadow);
    }
    
    .planTop{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    
    .planTop strong{font-size:14px; font-weight:600}
    
    .pill{
      font-size:11px;
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      background: white;
      color: var(--primary);
    }
    
    .planBar{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.3);
      overflow:hidden;
      margin-bottom:8px;
    }
    
    .planBar > div{
      height:100%;
      width:64%;
      background: white;
      border-radius:999px;
      position:relative;
      overflow:hidden;
    }
    
    .planBar > div::after{
      content:'';
      position:absolute;
      top:0; left:0; right:0; bottom:0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.5), transparent);
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer{
      0% {transform: translateX(-100%);}
      100% {transform: translateX(100%);}
    }
    
    .planMeta{
      display:flex; justify-content:space-between;
      font-size:12px;
      opacity:.9;
      font-weight:500;
    }

    .helpRow{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    
    .helpRow a{
      text-decoration:none;
      padding:12px;
      border-radius:var(--radius);
      border:1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      font-weight:600;
      font-size:13px;
      display:flex; align-items:center; justify-content:center; gap:8px;
      transition:all .2s ease;
    }
    
    .helpRow a:hover{
      background: var(--gradient-primary);
      color:white;
      border-color:var(--primary);
      transform:translateY(-2px);
    }

    /* ====== MAIN ====== */
    .main{
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width:0;
      background: var(--bg2);
    }

    /* TOPBAR */
    .topbar{
      height:80px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 28px;
      background: var(--bg1);
      border-bottom:1px solid var(--stroke);
      box-shadow: var(--shadow-card);
      z-index:5;
    }
    
    .searchWrap{
      display:flex; align-items:center; gap:16px;
      flex:1;
      max-width:600px;
    }
    
    .search{
      flex:1;
      display:flex; align-items:center; gap:12px;
      padding:12px 20px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      transition:all .2s ease;
      min-width:300px;
    }
    
    .search:focus-within{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,.1);
    }
    
    .search i{color:var(--muted)}
    
    .search input{
      flex:1;
      background:transparent;
      border:none;
      outline:none;
      color:var(--text);
      font-weight:500;
      font-size:14px;
    }
    
    .search input::placeholder{color:var(--muted)}
    
    .quick-action{
      padding:12px 20px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--gradient-primary);
      color:white;
      font-weight:600;
      font-size:14px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      transition:all .2s ease;
      white-space:nowrap;
    }
    
    .quick-action:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow);
    }
    
    .rightTools{
      display:flex; align-items:center; gap:16px;
    }
    
    .notifications{
      position:relative;
      cursor:pointer;
    }
    
    .notification-badge{
      position:absolute;
      top:-8px; right:-8px;
      background:var(--bad);
      color:white;
      font-size:11px;
      font-weight:700;
      width:20px; height:20px;
      border-radius:50%;
      display:grid; place-items:center;
    }
    
    /* Language Selector */
    .langSelect{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      cursor:pointer;
      user-select:none;
    }
    .langSelect select{
      background:transparent;
      border:none;
      outline:none;
      color: var(--text);
      font-weight:600;
      cursor:pointer;
    }
    
    .userBox{
      display:flex; align-items:center; gap:12px;
      padding:8px 16px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--bg1);
      cursor:pointer;
      transition:all .2s ease;
    }
    
    .userBox:hover{
      border-color:var(--primary);
      box-shadow:var(--shadow-card);
    }
    
    .avatar{
      width:42px; height:42px;
      border-radius:50%;
      overflow:hidden;
      border:3px solid var(--stroke);
      background: var(--gradient-primary);
      display:grid; place-items:center;
      color:white;
      font-weight:600;
      font-size:16px;
    }
    
    .userMeta{line-height:1.3}
    
    .userMeta strong{
      font-size:14px;
      font-weight:600;
      display:block;
    }
    
    .userMeta div{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
    }
    
    .siteBtn{
      padding:12px 24px;
      border-radius:var(--radius);
      border:1px solid var(--primary);
      background:white;
      color:var(--primary);
      font-weight:600;
      cursor:pointer;
      display:flex; align-items:center; gap:10px;
      transition:all .2s ease;
    }
    
    .siteBtn:hover{
      background:var(--gradient-primary);
      color:white;
      transform:translateY(-2px);
      box-shadow:var(--shadow);
    }

    /* CONTENT */
    .content{
      padding:28px;
      overflow:auto;
      height:calc(100% - 80px);
    }

    /* Cards / UI */
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:24px;
      align-items:start;
    }
    
    .panel{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow);
      overflow:hidden;
      margin-bottom:24px;
    }
    
    .panelHeader{
      padding:20px 24px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid var(--stroke);
      background:var(--bg1);
    }
    
    .panelHeader .hTitle{
      display:flex; flex-direction:column;
      gap:6px;
    }
    
    .panelHeader .hTitle strong{
      font-size:18px;
      font-weight:700;
      color:var(--text);
    }
    
    .panelHeader .hTitle span{
      font-size:14px;
      color:var(--muted);
      font-weight:500;
    }
    
    .panelBody{padding:24px}

    /* Metric cards */
    .metrics{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:20px;
      margin-bottom:24px;
    }
    
    .mCard{
      border-radius:var(--radius-xl);
      border:1px solid var(--stroke);
      background:var(--card);
      padding:20px;
      transition:all .3s ease;
      position:relative;
      overflow:hidden;
    }
    
    .mCard:hover{
      transform:translateY(-4px);
      border-color:var(--primary);
      box-shadow:var(--shadow-lg);
    }
    
    /* Glow effect corrigido para tema claro */
    .mCard::before{
      content:"";
      position:absolute;
      inset:-40px -60px auto -60px;
      height:120px;
      background: radial-gradient(closest-side, rgba(37, 99, 235, 0.1), transparent 70%);
      filter: blur(8px);
      opacity:.5;
      pointer-events:none;
    }
    
    .mTop{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:16px;
      position:relative;
      z-index:2;
    }
    
    .mTop .icon{
      width:48px; height:48px;
      border-radius:14px;
      display:grid; place-items:center;
      background:var(--gradient-primary);
      color:white;
      font-size:20px;
    }
    
    .mVal{
      font-size:32px;
      font-weight:800;
      color:var(--text);
      margin-bottom:4px;
      position:relative;
      z-index:2;
    }
    
    .mLbl{
      font-size:14px;
      color:var(--muted);
      font-weight:500;
      margin-bottom:12px;
      position:relative;
      z-index:2;
    }
    
    .mDelta{
      display:flex; align-items:center; gap:8px;
      font-size:13px;
      font-weight:600;
      position:relative;
      z-index:2;
    }
    
    .mDelta .up{color:var(--good)}
    .mDelta .down{color:var(--bad)}
    .mDelta .flat{color:var(--warn)}

    /* Chart */
    .chartWrap{
      height:300px;
      border-radius:var(--radius-xl);
      border:1px solid var(--stroke);
      background:var(--card);
      padding:20px;
      margin-bottom:24px;
      position:relative;
    }
    
    .chartContainer{
      width:100%;
      height:100%;
      position:relative;
    }

    /* Chart hint */
    .chartHint{
      position:absolute;
      right:14px; top:14px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      font-size:12px;
      font-weight:600;
      color: var(--text);
      z-index:10;
    }

    /* Buttons */
    .btn{
      padding:12px 24px;
      border-radius:var(--radius);
      border:none;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      display:inline-flex; align-items:center; gap:10px;
      transition:all .2s ease;
    }
    
    .btn-primary{
      background:var(--gradient-primary);
      color:white;
    }
    
    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:var(--shadow);
    }
    
    .btn-secondary{
      background:white;
      color:var(--primary);
      border:1px solid var(--stroke);
    }
    
    .btn-secondary:hover{
      border-color:var(--primary);
      background:var(--card2);
    }
    
    .btn-success{
      background:var(--good);
      color:white;
    }
    
    .btn-outline{
      background:transparent;
      color:var(--text);
      border:1px solid var(--stroke);
    }
    
    .btn-outline:hover{
      border-color:var(--primary);
      background:var(--card2);
    }

    /* Buttons Lite */
    .btnLite{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      color: var(--text);
      font-weight:600;
      cursor:pointer;
      transition:.18s ease;
      display:flex; align-items:center; gap:10px;
      user-select:none;
      font-size:14px;
    }
    .btnLite:hover{transform: translateY(-1px); border-color: var(--stroke2)}
    .btnLite.btnGood{
      border-color: rgba(16, 185, 129, 0.35);
      background: rgba(16, 185, 129, 0.10);
    }
    .btnLite.btnWarn{
      border-color: rgba(245, 158, 11, 0.35);
      background: rgba(245, 158, 11, 0.10);
    }

    /* Tables */
    .tableContainer{
      overflow-x:auto;
      border-radius:var(--radius-lg);
      border:1px solid var(--stroke);
    }
    
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
    }
    
    .table th{
      text-align:left;
      padding:16px 20px;
      background:var(--bg2);
      border-bottom:1px solid var(--stroke);
      font-size:13px;
      color:var(--muted);
      font-weight:600;
      white-space:nowrap;
    }
    
    .table td{
      padding:16px 20px;
      border-bottom:1px solid var(--stroke);
      font-size:14px;
      font-weight:500;
    }
    
    .table tr:hover td{
      background:var(--card2);
    }
    
    .table tr:last-child td{
      border-bottom:none;
    }

    .status-badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 14px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
    }
    
    .status-new{
      background:#dbeafe;
      color:#1d4ed8;
    }
    
    .status-active{
      background:#dcfce7;
      color:#166534;
    }
    
    .status-pending{
      background:#fef3c7;
      color:#92400e;
    }
    
    .status-sold{
      background:#fee2e2;
      color:#991b1b;
    }

    /* Tags */
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--bg2);
      font-size:12px;
      font-weight:600;
    }
    .tag.good{border-color: rgba(16, 185, 129, 0.35); background: rgba(16, 185, 129, 0.10)}
    .tag.warn{border-color: rgba(245, 158, 11, 0.35); background: rgba(245, 158, 11, 0.10)}
    .tag.bad{border-color: rgba(239, 68, 68, 0.35); background: rgba(239, 68, 68, 0.10)}

    /* Kanban */
    .kanban{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:20px;
      margin-bottom:24px;
    }
    
    .kanban-column{
      background:var(--card2);
      border:1px solid var(--stroke);
      border-radius:var(--radius-xl);
      overflow:hidden;
      min-height:400px;
    }
    
    .kanban-header{
      padding:16px 20px;
      border-bottom:1px solid var(--stroke);
      background:var(--bg1);
      display:flex; align-items:center; justify-content:space-between;
      font-weight:600;
    }
    
    .kanban-body{
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:300px;
    }
    
    .kanban-card{
      background:white;
      border:1px solid var(--stroke);
      border-radius:var(--radius-lg);
      padding:16px;
      cursor:move;
      transition:all .2s ease;
      box-shadow:var(--shadow-card);
    }
    
    .kanban-card:hover{
      transform:translateY(-2px);
      border-color:var(--primary);
      box-shadow:var(--shadow);
    }
    
    .kanban-card-title{
      font-weight:600;
      margin-bottom:8px;
      color:var(--text);
    }
    
    .kanban-card-meta{
      display:flex; gap:12px;
      font-size:12px;
      color:var(--muted);
    }

    /* Forms */
    .form-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:20px;
    }
    
    .form-group{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    
    .form-group label{
      font-size:14px;
      font-weight:600;
      color:var(--text);
    }
    
    .form-control{
      padding:12px 16px;
      border-radius:var(--radius);
      border:1px solid var(--stroke);
      background:white;
      color:var(--text);
      font-size:14px;
      transition:all .2s ease;
    }
    
    .form-control:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,.1);
    }
    
    .form-actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:24px;
      padding-top:20px;
      border-top:1px solid var(--stroke);
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
      padding:20px;
      backdrop-filter:blur(4px);
    }
    
    .modal{
      width:100%;
      max-width:800px;
      background:white;
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-lg);
      overflow:hidden;
      animation:modalIn .3s ease;
    }
    
    @keyframes modalIn{
      from{opacity:0; transform:translateY(-20px)}
      to{opacity:1; transform:translateY(0)}
    }
    
    .modal-header{
      padding:20px 24px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between;
      background:var(--bg1);
    }
    
    .modal-body{
      padding:24px;
      max-height:70vh;
      overflow-y:auto;
    }
    
    .modal-footer{
      padding:20px 24px;
      border-top:1px solid var(--stroke);
      display:flex; justify-content:flex-end;
      gap:12px;
    }

    /* Toast */
    .toast-container{
      position:fixed;
      top:24px;
      right:24px;
      z-index:1001;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    
    .toast{
      padding:16px 20px;
      border-radius:var(--radius);
      background:white;
      border-left:4px solid var(--primary);
      box-shadow:var(--shadow-lg);
      display:flex;
      align-items:center;
      gap:12px;
      animation:toastIn .3s ease;
      min-width:300px;
    }
    
    @keyframes toastIn{
      from{opacity:0; transform:translateX(100%)}
      to{opacity:1; transform:translateX(0)}
    }
    
    .toast-success{
      border-left-color:var(--good);
    }
    
    .toast-error{
      border-left-color:var(--bad);
    }
    
    .toast-warning{
      border-left-color:var(--warn);
    }

    /* INBOX SYSTEM */
    .inbox{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
      min-height: 540px;
    }
    .inLeft, .inRight{
      border-radius:18px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      overflow:hidden;
    }
    .inLeftHead{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between;
      background: var(--bg2);
      font-weight:600;
    }
    .thread{
      padding:12px;
      border-bottom:1px solid var(--stroke);
      cursor:pointer;
      transition:.18s ease;
    }
    .thread:hover{background: var(--bg2)}
    .thread.active{background: rgba(37, 99, 235, 0.08)}
    .thread strong{display:block; font-weight:600}
    .thread span{font-size:12px;color: var(--muted);font-weight:500}
    .inRightHead{
      padding:12px 14px;
      border-bottom:1px solid var(--stroke);
      background: var(--bg2);
      display:flex; align-items:center; justify-content:space-between;
    }
    .msgArea{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      height: 420px;
      overflow:auto;
    }
    .bubble{
      max-width: 72%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      box-shadow: var(--shadow-card);
      font-weight:500;
    }
    .bubble.me{
      margin-left:auto;
      border-color: rgba(16, 185, 129, 0.25);
      background: rgba(16, 185, 129, 0.10);
    }
    .composer{
      padding:12px;
      border-top:1px solid var(--stroke);
      display:flex; gap:10px;
      background: var(--bg2);
    }
    .composer input{
      flex:1;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      outline:none;
      color: var(--text);
      font-weight:500;
    }

    /* Site Preview */
    .sitePreview{
      border-radius: var(--radius-xl);
      border: 1px solid var(--stroke);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: var(--bg1);
    }
    .siteTop{
      padding:16px 18px;
      background: var(--gradient-primary);
      border-bottom:1px solid var(--stroke);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .siteLogo{
      display:flex; align-items:center; gap:12px;
      font-weight:700;
      letter-spacing:.2px;
      color: white;
    }
    .siteLogo .dot{
      width:14px; height:14px; border-radius:999px;
      background: var(--secondary);
      box-shadow: 0 0 0 6px rgba(56,189,248,.12);
    }
    .siteFrame{
      padding:18px;
    }
    .siteHero{
      border-radius:18px;
      padding:18px;
      border:1px solid var(--stroke);
      background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(14, 165, 233, 0.03));
      position:relative;
      overflow:hidden;
    }
    .siteHero h3{
      margin:0 0 6px 0;
      font-size:18px;
      color: var(--text);
    }
    .siteHero p{
      margin:0;
      max-width: 680px;
      color: var(--muted);
      font-weight:500;
      font-size:13px;
    }
    .siteCards{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:12px;
    }
    .pCard{
      border-radius:16px;
      border:1px solid var(--stroke);
      background: var(--bg1);
      overflow:hidden;
      transition:.18s ease;
      cursor:pointer;
    }
    .pCard:hover{transform: translateY(-1px); border-color: var(--stroke2)}
    .pImg{
      height:120px;
      background: var(--gradient-secondary);
      border-bottom:1px solid var(--stroke);
      position:relative;
      overflow:hidden;
    }
    .pImg img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .pBody{padding:10px}
    .pBody strong{display:block; font-weight:600}
    .pBody span{display:block; margin-top:4px; color: var(--muted); font-weight:500; font-size:12px}

    /* Calendar View */
    .calendar{
      background: white;
      border-radius: var(--radius-xl);
      border: 1px solid var(--stroke);
      overflow: hidden;
    }
    .calendar-header{
      padding: 20px;
      background: var(--gradient-primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .calendar-body{
      padding: 20px;
    }
    .calendar-grid{
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    .calendar-day-header{
      padding: 12px;
      text-align: center;
      font-weight: 600;
      color: var(--muted);
    }
    .calendar-day{
      padding: 12px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .calendar-day:hover{
      background: var(--primary-light);
      color: white;
    }
    .calendar-day.today{
      background: var(--primary);
      color: white;
    }
    .calendar-day.event{
      position: relative;
    }
    .calendar-day.event::after{
      content: '';
      position: absolute;
      bottom: 5px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--good);
    }
    .calendar-events{
      margin-top: 20px;
    }
    .event-item{
      padding: 12px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Photo Upload */
    .photo-upload-area{
      border: 2px dashed var(--stroke);
      border-radius: var(--radius);
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--bg2);
    }
    .photo-upload-area:hover{
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.05);
    }
    .photo-upload-area i{
      font-size: 48px;
      color: var(--muted);
      margin-bottom: 16px;
    }
    .photo-preview{
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }
    .photo-preview-item{
      position: relative;
      border-radius: var(--radius);
      overflow: hidden;
      height: 120px;
    }
    .photo-preview-item img{
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-preview-item button{
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Notifications Modal */
    .notifications-modal .modal{
      max-width: 400px;
    }
    .notification-item{
      padding: 16px;
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .notification-item:last-child{
      border-bottom: none;
    }
    .notification-icon{
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--gradient-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      flex-shrink: 0;
    }
    .notification-content{
      flex: 1;
    }
    .notification-time{
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Views system */
    .view{display:none}
    .view.active{display:block}

    /* Responsive */
    @media (max-width: 1200px){
      .metrics{grid-template-columns:repeat(2, 1fr)}
      .grid{grid-template-columns:1fr}
      .siteCards{grid-template-columns:repeat(2, 1fr)}
      .inbox{grid-template-columns:1fr}
      .kanban{grid-template-columns: repeat(3, 1fr)}
    }
    
    @media (max-width: 992px){
      .app{grid-template-columns:1fr}
      .sidebar{display:none}
      .sidebar-mobile-toggle{
        display:flex;
        align-items:center;
        justify-content:center;
        width:40px;
        height:40px;
        border-radius:var(--radius);
        border:1px solid var(--stroke);
        background:white;
        cursor:pointer;
      }
      .search{min-width:auto}
      .kanban{grid-template-columns:1fr}
      .form-grid{grid-template-columns:1fr}
      .siteCards{grid-template-columns:1fr}
    }
    
    @media (max-width: 768px){
      .metrics{grid-template-columns:1fr}
      .topbar{padding:0 16px}
      .content{padding:16px}
      .rightTools{display:none}
    }

    /* Animations */
    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }
    
    .fade-in{
      animation:fadeIn .3s ease;
    }

    /* Drag and drop */
    .dragging{
      opacity:.5;
      transform:rotate(3deg);
    }
    
    .drop-zone{
      min-height:100px;
      border:2px dashed var(--stroke);
      border-radius:var(--radius);
      display:grid; place-items:center;
      color:var(--muted);
      transition:all .2s ease;
    }
    
    .drop-zone.drag-over{
      border-color:var(--primary);
      background:rgba(37,99,235,.05);
    }

    /* Progress bars */
    .progress{
      height:8px;
      border-radius:999px;
      background:var(--stroke);
      overflow:hidden;
    }
    
    .progress-bar{
      height:100%;
      background:var(--gradient-primary);
      border-radius:999px;
      transition:width .3s ease;
    }

    /* === NOVAS ADIÇÕES PARA CORREÇÕES === */
    
    /* Melhorias de acessibilidade */
    :focus-visible {
      outline: 3px solid var(--primary);
      outline-offset: 2px;
    }

    /* Estados de erro */
    .input-error {
      border-color: var(--bad) !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
    }

    /* Loading spinner */
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid var(--stroke);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Animações suaves */
    .fade-out {
      animation: fadeOut 0.3s ease;
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* Tooltips */
    [data-tooltip] {
      position: relative;
    }

    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: white;
      padding: 6px 12px;
      border-radius: var(--radius);
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
    }

    /* Campos obrigatórios */
    .required-star {
      color: var(--bad);
      margin-left: 2px;
    }

    /* Responsividade adicional */
    @media (max-width: 480px) {
      .modal {
        margin: 10px;
      }
      
      .btn {
        padding: 10px 16px;
        font-size: 13px;
      }
      
      .mVal {
        font-size: 24px;
      }
      
      .toast {
        min-width: 250px;
        padding: 12px 16px;
      }
    }
    
    <link rel="stylesheet" href="./kanban.css" />

    /* Unread notification */
    .notification-item.unread {
      background: rgba(37, 99, 235, 0.05);
      border-left: 3px solid var(--primary);
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="mark"><i class="fa-solid fa-building"></i></div>
        <div class="title">
          <strong>ImobiPro</strong>
          <span data-i18n="crm_subtitle">CRM Corretor</span>
        </div>
      </div>

      <nav class="nav" id="nav">
        <button class="active" data-view="dashboard" onclick="switchView('dashboard')">
          <i class="fa-solid fa-chart-line"></i>
          <span data-i18n="nav_dashboard">Dashboard</span>
          <span class="badge" id="badgeDashboard">0</span>
        </button>
        <button data-view="properties" onclick="switchView('properties')">
          <i class="fa-solid fa-house-chimney-window"></i>
          <span data-i18n="nav_properties">Imóveis</span>
          <span class="badge" id="badgeProperties">0</span>
        </button>
        <button data-view="leads" onclick="switchView('leads')">
          <i class="fa-solid fa-users"></i>
          <span data-i18n="nav_leads">Leads</span>
          <span class="badge" id="badgeLeads">0</span>
        </button>
        <button data-view="messages" onclick="switchView('messages')">
          <i class="fa-solid fa-inbox"></i>
          <span data-i18n="nav_messages">Mensagens</span>
          <span class="badge" id="badgeMessages">0</span>
        </button>
        <button data-view="site" onclick="switchView('site')">
          <i class="fa-solid fa-globe"></i>
          <span data-i18n="nav_site">Site do Corretor</span>
          <span class="badge"><i class="fa-solid fa-eye"></i></span>
        </button>
        <button data-view="profile" onclick="switchView('profile')">
          <i class="fa-solid fa-user-gear"></i>
          <span data-i18n="nav_profile">Perfil & Aparência</span>
          <span class="badge">Pro</span>
        </button>
        <button data-view="calendar" onclick="switchView('calendar')">
          <i class="fa-solid fa-calendar-days"></i>
          <span data-i18n="nav_calendar">Agenda</span>
          <span class="badge" id="badgeCalendar">0</span>
        </button>
        <button data-view="reports" onclick="switchView('reports')">
          <i class="fa-solid fa-chart-pie"></i>
          <span data-i18n="nav_reports">Relatórios</span>
        </button>
      </nav>

      <div class="sidebarFooter">
        <div class="planCard">
          <div class="planTop">
            <strong data-i18n="plan_title">Plano Profissional</strong>
            <span class="pill">ATIVO</span>
          </div>
          <div class="planBar"><div id="planProgress" style="width: 0%"></div></div>
          <div class="planMeta">
            <span data-i18n="plan_usage"><span id="planPercentage">0</span>% utilizado</span>
            <span id="planRenewal">Renova: --/--</span>
          </div>
        </div>

        <div class="helpRow">
          <a href="#" onclick="showSupport()">
            <i class="fa-brands fa-whatsapp"></i> <span data-i18n="help_support">Suporte</span>
          </a>
          <a href="#" onclick="showDocs()">
            <i class="fa-regular fa-circle-question"></i> <span data-i18n="help_docs">Docs</span>
          </a>
          <a href="#" onclick="logout()">
            <i class="fa-solid fa-right-from-bracket"></i> <span data-i18n="btn_logout">Sair</span>
          </a>
        </div>

      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <div class="topbar">
        <div class="searchWrap">
          <button class="sidebar-mobile-toggle" onclick="toggleSidebar()" style="display:none">
            <i class="fa-solid fa-bars"></i>
          </button>
          
          <div class="search">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="globalSearch" type="text" placeholder="Buscar imóveis, leads, clientes..." />
          </div>
          
          <button class="quick-action" onclick="showNewPropertyModal()">
            <i class="fa-solid fa-plus"></i>
            <span data-i18n="chip_new_property">Novo Imóvel</span>
          </button>
        </div>

        <div id="kanban" class="kanban"></div>

        <div class="rightTools">
          <div class="notifications" onclick="showNotificationsModal()">
            <i class="fa-regular fa-bell" style="font-size:20px;color:var(--muted)"></i>
            <span class="notification-badge" id="notificationCount">0</span>
          </div>
          
          <!-- Language Selector -->
          <div class="langSelect" title="Language">
            <i class="fa-solid fa-language"></i>
            <select id="lang">
              <option value="pt">PT</option>
              <option value="en">EN</option>
              <option value="es">ES</option>
            </select>
          </div>
          
          <button class="siteBtn" onclick="openPublicSite()">
            <i class="fa-solid fa-up-right-from-square"></i>
            <span data-i18n="btn_view_site">Ver Site</span>
          </button>

          <div class="userBox" onclick="switchView('profile')">
            <div class="avatar" id="userAvatar">
              <span id="avatarInitials">GN</span>
              <img id="avatarImage" style="display:none;width:100%;height:100%;object-fit:cover" />
            </div>
            <div class="userMeta">
              <strong id="userName">Carregando...</strong>
              <div id="userRole">Carregando...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CONTENT AREA -->
      <div class="content" id="contentArea">
        
        <!-- DASHBOARD VIEW -->
        <section class="view active" id="view-dashboard">
          <div class="grid">
            <!-- Main Metrics -->
            <div class="panel">
              <div class="panelHeader">
                <div class="hTitle">
                  <strong data-i18n="dash_title">Visão Geral do Negócio</strong>
                  <span data-i18n="dash_sub">Performance e conversão em tempo real</span>
                </div>
                <div>
                  <select class="form-control" style="width:200px" id="periodSelect">
                    <option value="week">Esta Semana</option>
                    <option value="month" selected>Este Mês</option>
                    <option value="quarter">Este Trimestre</option>
                    <option value="year">Este Ano</option>
                  </select>
                </div>
              </div>

              <div class="panelBody">
                <!-- Metrics -->
                <div class="metrics">
                  <div class="mCard">
                    <div class="mTop">
                      <div>
                        <div class="mVal" id="mLeadsToday">0</div>
                        <div class="mLbl" data-i18n="m_leads_today">Leads hoje</div>
                      </div>
                      <div class="icon"><i class="fa-solid fa-bolt"></i></div>
                    </div>
                    <div class="mDelta"><span class="up">▲ 0%</span><span data-i18n="vs_yesterday">vs ontem</span></div>
                  </div>

                  <div class="mCard">
                    <div class="mTop">
                      <div>
                        <div class="mVal" id="mLeadsMonth">0</div>
                        <div class="mLbl" data-i18n="m_leads_month">Leads no mês</div>
                      </div>
                      <div class="icon"><i class="fa-solid fa-users"></i></div>
                    </div>
                    <div class="mDelta"><span class="up">▲ 0%</span><span data-i18n="vs_last_month">vs mês anterior</span></div>
                  </div>

                  <div class="mCard">
                    <div class="mTop">
                      <div>
                        <div class="mVal" id="mSiteVisits">0</div>
                        <div class="mLbl" data-i18n="m_site_visits">Visitas no site</div>
                      </div>
                      <div class="icon"><i class="fa-solid fa-globe"></i></div>
                    </div>
                    <div class="mDelta"><span class="up">▲ 0%</span><span data-i18n="this_week">esta semana</span></div>
                  </div>

                  <div class="mCard">
                    <div class="mTop">
                      <div>
                        <div class="mVal" id="mConversion">0%</div>
                        <div class="mLbl" data-i18n="m_conversion">Taxa de conversão</div>
                      </div>
                      <div class="icon"><i class="fa-solid fa-chart-simple"></i></div>
                    </div>
                    <div class="mDelta"><span class="flat">●</span><span data-i18n="stable">estável</span></div>
                  </div>
                </div>

                <!-- Chart -->
                <div class="chartWrap">
                  <div class="chartContainer">
                    <div class="chartHint" data-i18n="chart_hint">Leads x Conversão (7 dias)</div>
                    <canvas id="performanceChart"></canvas>
                  </div>
                </div>

                <!-- Recent Leads Table -->
                <div class="panel" style="margin-top:20px">
                  <div class="panelHeader">
                    <div class="hTitle">
                      <strong data-i18n="recent_leads_title">Leads recentes</strong>
                      <span data-i18n="recent_leads_sub">Acompanhe quem entrou hoje e priorize o atendimento</span>
                    </div>
                    <button class="btn btn-outline" onclick="switchView('leads')">
                      <i class="fa-solid fa-arrow-right"></i> <span data-i18n="see_all">Ver tudo</span>
                    </button>
                  </div>
                  <div class="panelBody">
                    <div class="tableContainer">
                      <table class="table" id="recentLeadsTable">
                        <thead>
                          <tr>
                            <th data-i18n="th_name">Nome</th>
                            <th data-i18n="th_interest">Interesse</th>
                            <th data-i18n="th_source">Origem</th>
                            <th data-i18n="th_status">Status</th>
                          </tr>
                        </thead>
                        <tbody id="recentLeadsTbody"></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Right Sidebar with Quick Actions -->
            <div class="panel">
              <div class="panelHeader">
                <div class="hTitle">
                  <strong data-i18n="quick_actions">Ações Rápidas</strong>
                  <span data-i18n="quick_actions_sub">Atalhos inteligentes</span>
                </div>
                <button class="btnLite" onclick="showToast('Personalizar: em breve')">
                  <i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="btn_customize">Personalizar</span>
                </button>
              </div>
              <div class="panelBody">
                <div style="display:flex; flex-direction:column; gap:12px">
                  <button class="btnLite btnGood" onclick="showNewPropertyModal()">
                    <i class="fa-solid fa-plus"></i> <span data-i18n="action_new_property">Cadastrar Imóvel</span>
                  </button>
                  <button class="btnLite" onclick="showNewLeadModal()">
                    <i class="fa-solid fa-user-plus"></i> <span data-i18n="action_new_lead">Novo Lead</span>
                  </button>
                  <button class="btnLite" onclick="showScheduleModal()">
                    <i class="fa-solid fa-calendar-plus"></i> <span data-i18n="action_new_appointment">Novo Compromisso</span>
                  </button>
                  <button class="btnLite" onclick="switchView('site')">
                    <i class="fa-solid fa-globe"></i> <span data-i18n="action_site_preview">Prévia do Site</span>
                  </button>
                  <button class="btnLite" onclick="switchView('profile')">
                    <i class="fa-solid fa-user-pen"></i> <span data-i18n="action_edit_profile">Editar Perfil</span>
                  </button>
                  <button class="btnLite" onclick="generateReport()">
                    <i class="fa-solid fa-file-export"></i> <span data-i18n="action_generate_report">Gerar Relatório</span>
                  </button>
                </div>

                <!-- Today's Focus -->
                <div class="panel" style="margin-top:24px; border-radius:var(--radius-lg)">
                  <div class="panelHeader">
                    <div class="hTitle">
                      <strong data-i18n="focus_today">Foco de hoje</strong>
                      <span data-i18n="focus_today_sub">Tarefas para aumentar conversão</span>
                    </div>
                  </div>
                  <div class="panelBody" id="todaysFocus">
                    <div class="kanban-card" onclick="showToast('Carregando...')">
                      <div class="kanban-card-title" data-i18n="loading">Carregando tarefas...</div>
                      <div class="kanban-card-meta">
                        <span><i class="fa-regular fa-clock"></i> --</span>
                        <span><i class="fa-solid fa-bolt"></i> --</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- PROPERTIES VIEW -->
        <section class="view" id="view-properties">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="prop_title">Gestão de Imóveis</strong>
                <span data-i18n="prop_sub">Total: <span id="propertiesCount">0</span> imóveis</span>
              </div>
              <div style="display:flex; gap:12px">
                <button class="btn btn-outline" onclick="exportProperties()">
                  <i class="fa-solid fa-file-export"></i> <span data-i18n="btn_export">Exportar</span>
                </button>
                <button class="btn btn-primary" onclick="showNewPropertyModal()">
                  <i class="fa-solid fa-plus"></i> <span data-i18n="btn_new_property">Novo Imóvel</span>
                </button>
              </div>
            </div>
            <div class="panelBody">
              <!-- Kanban de Imóveis -->
              <div class="kanban" id="propertiesKanban">
                <!-- Será preenchido via JavaScript -->
              </div>

              <!-- Tabela de Imóveis -->
              <div class="panel" style="margin-top:24px">
                <div class="panelHeader">
                  <div class="hTitle">
                    <strong data-i18n="all_properties">Todos os Imóveis</strong>
                    <span data-i18n="detailed_view">Visão detalhada em tabela</span>
                  </div>
                  <button class="btn btn-outline" onclick="exportPropertiesCSV()">
                    <i class="fa-solid fa-file-export"></i> <span data-i18n="btn_export_csv">Exportar CSV</span>
                  </button>
                </div>
                <div class="panelBody">
                  <div class="tableContainer">
                    <table class="table" id="propertiesTable">
                      <thead>
                        <tr>
                          <th data-i18n="th_property">Imóvel</th>
                          <th data-i18n="th_type">Tipo</th>
                          <th data-i18n="th_location">Localização</th>
                          <th data-i18n="th_price">Preço</th>
                          <th data-i18n="th_status">Status</th>
                          <th data-i18n="th_visits">Visitas</th>
                          <th data-i18n="th_actions">Ações</th>
                        </tr>
                      </thead>
                      <tbody id="propertiesTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- LEADS VIEW -->
        <section class="view" id="view-leads">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="leads_title">Gestão de Leads</strong>
                <span data-i18n="leads_sub">Total: <span id="leadsCount">0</span> leads ativos</span>
              </div>
              <div style="display:flex; gap:12px">
                <button class="btn btn-outline" onclick="importLeads()">
                  <i class="fa-solid fa-file-import"></i> <span data-i18n="btn_import">Importar</span>
                </button>
                <button class="btn btn-primary" onclick="showNewLeadModal()">
                  <i class="fa-solid fa-user-plus"></i> <span data-i18n="btn_new_lead">Novo Lead</span>
                </button>
              </div>
            </div>
            <div class="panelBody">
              <!-- Kanban Board -->
              <div class="kanban" id="leadsKanban">
                <!-- Será preenchido via JavaScript -->
              </div>

              <!-- Leads Table -->
              <div class="panel" style="margin-top:24px">
                <div class="panelHeader">
                  <div class="hTitle">
                    <strong data-i18n="all_leads">Todos os Leads</strong>
                    <span data-i18n="detailed_view">Visão detalhada em tabela</span>
                  </div>
                  <button class="btn btn-outline" onclick="exportLeads()">
                    <i class="fa-solid fa-file-export"></i> <span data-i18n="btn_export_csv">Exportar CSV</span>
                  </button>
                </div>
                <div class="panelBody">
                  <div class="tableContainer">
                    <table class="table" id="leadsTable">
                      <thead>
                        <tr>
                          <th data-i18n="th_name">Nome</th>
                          <th data-i18n="th_contact">Contato</th>
                          <th data-i18n="th_interest">Interesse</th>
                          <th data-i18n="th_source">Fonte</th>
                          <th data-i18n="th_status">Status</th>
                          <th data-i18n="th_last_activity">Última Atividade</th>
                          <th data-i18n="th_actions">Ações</th>
                        </tr>
                      </thead>
                      <tbody id="leadsTbody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- MESSAGES VIEW -->
        <section class="view" id="view-messages">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="msg_title">Mensagens</strong>
                <span data-i18n="msg_sub">Inbox unificado (WhatsApp/Chat/Site)</span>
              </div>
              <button class="btn btn-outline" onclick="connectWhatsApp()">
                <i class="fa-brands fa-whatsapp"></i><span data-i18n="btn_connect_whats">Conectar WhatsApp</span>
              </button>
            </div>
            <div class="panelBody">
              <div class="inbox">
                <div class="inLeft">
                  <div class="inLeftHead">
                    <span data-i18n="threads">Conversas</span>
                    <span class="tag good"><i class="fa-solid fa-circle"></i> <span data-i18n="online">Online</span></span>
                  </div>
                  <div id="threads"></div>
                </div>

                <div class="inRight">
                  <div class="inRightHead">
                    <div>
                      <strong id="chatTitle">--</strong>
                      <div style="font-size:12px;color:var(--muted);font-weight:500" id="chatSub">
                        --
                      </div>
                    </div>
                    <button class="btnLite btnGood" onclick="showToast('Abrir lead: em breve')">
                      <i class="fa-solid fa-up-right-from-square"></i><span data-i18n="btn_open_lead">Abrir lead</span>
                    </button>
                  </div>
                  <div class="msgArea" id="chatArea">
                    <div style="text-align:center; padding:40px; color:var(--muted)">
                      <i class="fa-solid fa-comments" style="font-size:48px; margin-bottom:16px"></i>
                      <div data-i18n="no_messages">Selecione uma conversa para começar</div>
                    </div>
                  </div>
                  <div class="composer">
                    <input id="msgInput" type="text" placeholder="Escreva uma mensagem..." />
                    <button class="btn btn-primary" onclick="sendMessage()">
                      <i class="fa-solid fa-paper-plane"></i><span data-i18n="btn_send">Enviar</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- SITE VIEW -->
        <section class="view" id="view-site">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="site_title">Site do Corretor</strong>
                <span data-i18n="site_sub">Prévia em tempo real das cores, logo e vitrine</span>
              </div>
              <div style="display:flex; gap:12px">
                <button class="btn btn-outline" onclick="openPublicSite()">
                  <i class="fa-solid fa-up-right-from-square"></i><span data-i18n="btn_open_public">Abrir público</span>
                </button>
                <button class="btn btn-primary" onclick="switchView('profile')">
                  <i class="fa-solid fa-brush"></i><span data-i18n="btn_edit_appearance">Editar aparência</span>
                </button>
              </div>
            </div>
            <div class="panelBody">
              <div class="sitePreview">
                <div class="siteTop">
                  <div class="siteLogo">
                    <span class="dot"></span>
                    <span id="siteLogoText">Carregando...</span>
                  </div>
                  <span class="tag good"><i class="fa-solid fa-wand-magic-sparkles"></i> <span data-i18n="preview">Preview</span></span>
                </div>

                <div class="siteFrame">
                  <div class="siteHero" id="siteHero">
                    <h3 id="siteHeroTitle">Seu imóvel ideal está aqui.</h3>
                    <p id="siteHeroSub">Vitrine de imóveis atualizada automaticamente pelo seu CRM. Atendimento rápido e profissional.</p>
                  </div>

                  <div class="siteCards" id="siteCards">
                    <div style="text-align:center; padding:40px; color:var(--muted); grid-column:1/-1">
                      <i class="fa-solid fa-house" style="font-size:48px; margin-bottom:16px"></i>
                      <div data-i18n="no_properties">Cadastre seu primeiro imóvel para aparecer aqui</div>
                    </div>
                  </div>

                  <div style="height:12px"></div>
                  <div class="hint" data-i18n="site_hint">
                    Dica: ao cadastrar um imóvel no CRM, ele aparece aqui e depois no site público.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- PROFILE VIEW -->
        <section class="view" id="view-profile">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="profile_title">Perfil & Aparência</strong>
                <span data-i18n="profile_sub">Foto, logo e cores do seu site (prévia instantânea)</span>
              </div>
              <button class="btn btn-primary" onclick="saveProfile()">
                <i class="fa-solid fa-floppy-disk"></i><span data-i18n="btn_save">Salvar</span>
              </button>
            </div>
            <div class="panelBody">
              <div class="form-grid">
                <div class="form-group">
                  <label for="fBrokerName" data-i18n="f_broker_name">Nome do corretor <span class="required-star">*</span></label>
                  <input id="fBrokerName" class="form-control" value="" required />
                </div>
                <div class="form-group">
                  <label for="fCreci" data-i18n="f_creci">CRECI</label>
                  <input id="fCreci" class="form-control" value="" />
                </div>
                <div class="form-group">
                  <label for="fWhatsapp" data-i18n="f_whatsapp">WhatsApp <span class="required-star">*</span></label>
                  <input id="fWhatsapp" class="form-control" value="" required />
                </div>
                <div class="form-group">
                  <label for="fSiteName" data-i18n="f_site_name">Nome do site <span class="required-star">*</span></label>
                  <input id="fSiteName" class="form-control" value="" required />
                </div>

                <div class="form-group">
                  <label data-i18n="f_primary_color">Cor primária do site <span class="required-star">*</span></label>
                  <div style="display:flex; gap:12px; align-items:center">
                    <input id="fPrimary" type="color" class="form-control" value="#2563eb" style="width:60px; padding:4px" required />
                    <input id="fPrimaryText" type="text" class="form-control" value="#2563eb" style="flex:1" required />
                  </div>
                </div>
                <div class="form-group">
                  <label data-i18n="f_secondary_color">Cor secundária do site <span class="required-star">*</span></label>
                  <div style="display:flex; gap:12px; align-items:center">
                    <input id="fSecondary" type="color" class="form-control" value="#0ea5e9" style="width:60px; padding:4px" required />
                    <input id="fSecondaryText" type="text" class="form-control" value="#0ea5e9" style="flex:1" required />
                  </div>
                </div>

                <div class="form-group" style="grid-column:1 / -1">
                  <label for="fBio" data-i18n="f_bio">Descrição curta (hero do site) <span class="required-star">*</span></label>
                  <textarea id="fBio" class="form-control" required></textarea>
                </div>

                <div class="form-group">
                  <label for="fPhoto" data-i18n="f_photo">Foto do corretor (preview)</label>
                  <input id="fPhoto" type="file" class="form-control" accept="image/*" />
                  <div class="hint" data-i18n="hint_photo">A foto aparece no topo do CRM e no seu perfil.</div>
                </div>

                <div class="form-group">
                  <label for="fLogo" data-i18n="f_logo">Logo do site (preview)</label>
                  <input id="fLogo" type="file" class="form-control" accept="image/*" />
                  <div class="hint" data-i18n="hint_logo">A logo será usada no site público e materiais.</div>
                </div>
              </div>

              <!-- Preview -->
              <div class="panel" style="margin-top:24px; border-radius:var(--radius-lg)">
                <div class="panelHeader">
                  <div class="hTitle">
                    <strong data-i18n="preview_title">Prévia instantânea</strong>
                    <span data-i18n="preview_sub">Veja como o cliente vai enxergar seu site</span>
                  </div>
                  <button class="btn btn-outline" onclick="switchView('site')">
                    <i class="fa-solid fa-globe"></i> <span data-i18n="btn_go_preview">Ir para prévia</span>
                  </button>
                </div>
                <div class="panelBody">
                  <div class="sitePreview">
                    <div class="siteTop">
                      <div class="siteLogo">
                        <span class="dot"></span>
                        <span id="siteLogoText2">Carregando...</span>
                      </div>
                      <span class="tag good"><i class="fa-solid fa-eye"></i> <span data-i18n="live">Live</span></span>
                    </div>
                    <div class="siteFrame">
                      <div class="siteHero">
                        <h3 id="siteHeroTitle2">Seu imóvel ideal está aqui.</h3>
                        <p id="siteHeroSub2">Carregando descrição...</p>
                      </div>
                      <div class="hint" style="margin-top:12px" data-i18n="hint_live">
                        Tudo que você mudar aqui reflete na prévia do site.
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- CALENDAR VIEW -->
        <section class="view" id="view-calendar">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="calendar_title">Agenda</strong>
                <span data-i18n="calendar_sub">Visitas e compromissos</span>
              </div>
              <button class="btn btn-primary" onclick="showScheduleModal()">
                <i class="fa-solid fa-calendar-plus"></i> <span data-i18n="btn_new_appointment">Novo Compromisso</span>
              </button>
            </div>
            <div class="panelBody">
              <div class="calendar">
                <div class="calendar-header">
                  <button class="btn btn-outline" style="background:white;color:var(--text)" onclick="prevMonth()">
                    <i class="fa-solid fa-chevron-left"></i>
                  </button>
                  <h3 id="currentMonth">Carregando...</h3>
                  <button class="btn btn-outline" style="background:white;color:var(--text)" onclick="nextMonth()">
                    <i class="fa-solid fa-chevron-right"></i>
                  </button>
                </div>
                <div class="calendar-body">
                  <div class="calendar-grid" id="calendarGrid">
                    <!-- Dias da semana -->
                    <div class="calendar-day-header" data-i18n="sun">Dom</div>
                    <div class="calendar-day-header" data-i18n="mon">Seg</div>
                    <div class="calendar-day-header" data-i18n="tue">Ter</div>
                    <div class="calendar-day-header" data-i18n="wed">Qua</div>
                    <div class="calendar-day-header" data-i18n="thu">Qui</div>
                    <div class="calendar-day-header" data-i18n="fri">Sex</div>
                    <div class="calendar-day-header" data-i18n="sat">Sáb</div>
                    <!-- Dias serão gerados pelo JavaScript -->
                  </div>
                  <div class="calendar-events" id="calendarEvents">
                    <h4 data-i18n="todays_appointments">Compromissos de Hoje</h4>
                    <div id="todaysEvents">
                      <div style="text-align:center; padding:20px; color:var(--muted)">
                        <i class="fa-solid fa-calendar-check" style="font-size:32px; margin-bottom:12px"></i>
                        <div data-i18n="no_events_today">Nenhum compromisso para hoje</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- REPORTS VIEW -->
        <section class="view" id="view-reports">
          <div class="panel">
            <div class="panelHeader">
              <div class="hTitle">
                <strong data-i18n="reports_title">Relatórios</strong>
                <span data-i18n="reports_sub">Análise detalhada do desempenho</span>
              </div>
              <button class="btn btn-primary" onclick="generateReportPDF()">
                <i class="fa-solid fa-file-pdf"></i> <span data-i18n="btn_generate_pdf">Gerar Relatório PDF</span>
              </button>
            </div>
            <div class="panelBody">
              <div class="grid">
                <div class="panel">
                  <div class="panelHeader">
                    <strong data-i18n="monthly_performance">Desempenho Mensal</strong>
                    <button class="btn btn-outline" onclick="generateMonthlyReport()">
                      <i class="fa-solid fa-chart-column"></i> <span data-i18n="btn_generate_chart">Gerar Gráfico</span>
                    </button>
                  </div>
                  <div class="panelBody">
                    <div class="chartWrap">
                      <canvas id="monthlyReportChart"></canvas>
                    </div>
                  </div>
                </div>
                <div class="panel">
                  <div class="panelHeader">
                    <strong data-i18n="key_metrics">Métricas Chave</strong>
                  </div>
                  <div class="panelBody">
                    <div class="metrics">
                      <div class="mCard">
                        <div class="mVal" id="responseRate">0%</div>
                        <div class="mLbl" data-i18n="response_rate">Taxa de Resposta</div>
                      </div>
                      <div class="mCard">
                        <div class="mVal" id="conversionDays">0</div>
                        <div class="mLbl" data-i18n="conversion_days">Dias p/ Conversão</div>
                      </div>
                    </div>
                    <div style="margin-top:20px">
                      <button class="btn btn-primary" onclick="exportReportData()">
                        <i class="fa-solid fa-file-export"></i> <span data-i18n="btn_export_data">Exportar Dados</span>
                      </button>
                      <button class="btn btn-outline" onclick="printReport()" style="margin-left:12px">
                        <i class="fa-solid fa-print"></i> <span data-i18n="btn_print">Imprimir</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- MODAL: NOVO IMÓVEL COM FOTOS -->
  <div class="modal-backdrop" id="modalNewProperty">
    <div class="modal">
      <div class="modal-header">
        <strong data-i18n="modal_new_property">Cadastrar Novo Imóvel</strong>
        <button class="btn btn-outline" onclick="closeModal('modalNewProperty')" style="padding:8px">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="propertyForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="propertyTitle" data-i18n="label_property_title">Título do Imóvel <span class="required-star">*</span></label>
              <input type="text" id="propertyTitle" class="form-control" required
                     placeholder="Ex: Apartamento 2 quartos no Centro">
            </div>
            <div class="form-group">
              <label for="propertyType" data-i18n="label_property_type">Tipo <span class="required-star">*</span></label>
              <select id="propertyType" class="form-control" required>
                <option value="">Selecione...</option>
                <option value="apartment">Apartamento</option>
                <option value="house">Casa</option>
                <option value="commercial">Comercial</option>
                <option value="land">Terreno</option>
              </select>
            </div>
            <div class="form-group">
              <label for="propertyAddress" data-i18n="label_address">Endereço <span class="required-star">*</span></label>
              <input type="text" id="propertyAddress" class="form-control" required
                     placeholder="Rua, número, bairro">
            </div>
            <div class="form-group">
              <label for="propertyCity" data-i18n="label_city">Cidade <span class="required-star">*</span></label>
              <input type="text" id="propertyCity" class="form-control" required
                     placeholder="Cidade">
            </div>
            <div class="form-group">
              <label for="propertyPrice" data-i18n="label_price">Valor (R$) <span class="required-star">*</span></label>
              <input type="number" id="propertyPrice" class="form-control" required
                     placeholder="450000" min="0">
            </div>
            <div class="form-group">
              <label for="propertyArea" data-i18n="label_area">Área (m²)</label>
              <input type="number" id="propertyArea" class="form-control"
                     placeholder="120">
            </div>
            <div class="form-group">
              <label for="propertyBedrooms" data-i18n="label_bedrooms">Quartos</label>
              <input type="number" id="propertyBedrooms" class="form-control"
                     placeholder="2" min="0">
            </div>
            <div class="form-group">
              <label for="propertyBathrooms" data-i18n="label_bathrooms">Banheiros</label>
              <input type="number" id="propertyBathrooms" class="form-control"
                     placeholder="2" min="0">
            </div>
            <div class="form-group" style="grid-column:1 / -1">
              <label for="propertyDescription" data-i18n="label_description">Descrição <span class="required-star">*</span></label>
              <textarea id="propertyDescription" class="form-control" rows="4" required
                        placeholder="Descreva o imóvel, suas características, localização, comodidades..."></textarea>
            </div>
            
            <!-- Upload de Fotos -->
            <div class="form-group" style="grid-column:1 / -1">
              <label data-i18n="label_photos">Fotos do Imóvel <span class="required-star">*</span></label>
              <div class="photo-upload-area" id="photoUploadArea" onclick="document.getElementById('propertyPhotos').click()">
                <i class="fa-solid fa-cloud-arrow-up"></i>
                <h4 data-i18n="upload_area_title">Arraste fotos aqui ou clique para selecionar</h4>
                <p style="color:var(--muted); font-size:14px;" data-i18n="upload_formats">Formatos: JPG, PNG, WEBP (máx. 5MB por imagem)</p>
                <p style="color:var(--muted); font-size:12px;" data-i18n="upload_recommendation">Recomendado: 3-5 fotos do imóvel</p>
              </div>
              <input type="file" id="propertyPhotos" multiple accept="image/*" style="display:none" 
                     onchange="handlePropertyPhotos(event)" required>
              <div class="photo-preview" id="propertyPhotoPreview"></div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('modalNewProperty')" data-i18n="btn_cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="saveProperty()">
          <i class="fa-solid fa-save"></i> <span data-i18n="btn_save_property">Salvar Imóvel</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: NOVO LEAD -->
  <div class="modal-backdrop" id="modalNewLead">
    <div class="modal">
      <div class="modal-header">
        <strong data-i18n="modal_new_lead">Cadastrar Novo Lead</strong>
        <button class="btn btn-outline" onclick="closeModal('modalNewLead')" style="padding:8px">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="leadForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="leadName" data-i18n="label_lead_name">Nome Completo <span class="required-star">*</span></label>
              <input type="text" id="leadName" class="form-control" required
                     placeholder="Ex: João Silva">
            </div>
            <div class="form-group">
              <label for="leadEmail" data-i18n="label_email">E-mail</label>
              <input type="email" id="leadEmail" class="form-control"
                     placeholder="joao@email.com">
            </div>
            <div class="form-group">
              <label for="leadPhone" data-i18n="label_phone">Telefone/WhatsApp <span class="required-star">*</span></label>
              <input type="tel" id="leadPhone" class="form-control" required
                     placeholder="(83) 99999-9999">
            </div>
            <div class="form-group">
              <label for="leadSource" data-i18n="label_source">Origem <span class="required-star">*</span></label>
              <select id="leadSource" class="form-control" required>
                <option value="">Selecione...</option>
                <option value="site">Site</option>
                <option value="whatsapp">WhatsApp</option>
                <option value="instagram">Instagram</option>
                <option value="facebook">Facebook</option>
                <option value="referral">Indicação</option>
                <option value="other">Outro</option>
              </select>
            </div>
            <div class="form-group">
              <label for="leadInterest" data-i18n="label_interest">Interesse <span class="required-star">*</span></label>
              <select id="leadInterest" class="form-control" required>
                <option value="">Selecione...</option>
                <option value="apartment">Apartamento</option>
                <option value="house">Casa</option>
                <option value="commercial">Comercial</option>
                <option value="land">Terreno</option>
                <option value="rent">Aluguel</option>
              </select>
            </div>
            <div class="form-group">
              <label for="leadBudget" data-i18n="label_budget">Orçamento (R$)</label>
              <input type="number" id="leadBudget" class="form-control"
                     placeholder="Ex: 500000">
            </div>
            <div class="form-group" style="grid-column:1 / -1">
              <label for="leadNotes" data-i18n="label_notes">Observações</label>
              <textarea id="leadNotes" class="form-control" rows="3"
                        placeholder="Informações adicionais sobre o lead..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('modalNewLead')" data-i18n="btn_cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="saveLead()">
          <i class="fa-solid fa-save"></i> <span data-i18n="btn_save_lead">Salvar Lead</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: NOVO COMPROMISSO -->
  <div class="modal-backdrop" id="modalNewSchedule">
    <div class="modal">
      <div class="modal-header">
        <strong data-i18n="modal_new_schedule">Agendar Novo Compromisso</strong>
        <button class="btn btn-outline" onclick="closeModal('modalNewSchedule')" style="padding:8px">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <form id="scheduleForm">
          <div class="form-grid">
            <div class="form-group">
              <label for="scheduleTitle" data-i18n="label_title">Título <span class="required-star">*</span></label>
              <input type="text" id="scheduleTitle" class="form-control" required
                     placeholder="Ex: Visita ao apartamento">
            </div>
            <div class="form-group">
              <label for="scheduleType" data-i18n="label_type">Tipo <span class="required-star">*</span></label>
              <select id="scheduleType" class="form-control" required>
                <option value="">Selecione...</option>
                <option value="visit">Visita</option>
                <option value="meeting">Reunião</option>
                <option value="contract">Assinatura de Contrato</option>
                <option value="followup">Follow-up</option>
                <option value="other">Outro</option>
              </select>
            </div>
            <div class="form-group">
              <label for="scheduleDate" data-i18n="label_date">Data <span class="required-star">*</span></label>
              <input type="date" id="scheduleDate" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="scheduleTime" data-i18n="label_time">Hora <span class="required-star">*</span></label>
              <input type="time" id="scheduleTime" class="form-control" required>
            </div>
            <div class="form-group">
              <label for="scheduleClient" data-i18n="label_client">Cliente/Lead</label>
              <select id="scheduleClient" class="form-control">
                <option value="">Selecione um lead...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="scheduleProperty" data-i18n="label_property">Imóvel</label>
              <select id="scheduleProperty" class="form-control">
                <option value="">Selecione um imóvel...</option>
              </select>
            </div>
            <div class="form-group" style="grid-column:1 / -1">
              <label for="scheduleDescription" data-i18n="label_description">Descrição</label>
              <textarea id="scheduleDescription" class="form-control" rows="3"
                        placeholder="Detalhes do compromisso..."></textarea>
            </div>
            <div class="form-group">
              <label for="scheduleReminder" data-i18n="label_reminder">Lembrete</label>
              <select id="scheduleReminder" class="form-control">
                <option value="">Sem lembrete</option>
                <option value="5">5 minutos antes</option>
                <option value="15">15 minutos antes</option>
                <option value="30">30 minutos antes</option>
                <option value="60">1 hora antes</option>
                <option value="1440">1 dia antes</option>
              </select>
            </div>
            <div class="form-group">
              <label for="scheduleStatus" data-i18n="label_status">Status</label>
              <select id="scheduleStatus" class="form-control">
                <option value="scheduled">Agendado</option>
                <option value="confirmed">Confirmado</option>
                <option value="pending">Pendente</option>
                <option value="cancelled">Cancelado</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="closeModal('modalNewSchedule')" data-i18n="btn_cancel">Cancelar</button>
        <button class="btn btn-primary" onclick="saveSchedule()">
          <i class="fa-solid fa-calendar-check"></i> <span data-i18n="btn_schedule">Agendar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL: NOTIFICAÇÕES -->
  <div class="modal-backdrop notifications-modal" id="modalNotifications">
    <div class="modal">
      <div class="modal-header">
        <strong data-i18n="notifications_title">Notificações</strong>
        <button class="btn btn-outline" onclick="closeModal('modalNotifications')" style="padding:8px">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div id="notificationsList">
          <div style="text-align:center; padding:40px; color:var(--muted)">
            <i class="fa-regular fa-bell" style="font-size:48px; margin-bottom:16px"></i>
            <div data-i18n="no_notifications">Nenhuma notificação</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="markAllNotificationsRead()">
          <i class="fa-solid fa-check-double"></i> <span data-i18n="btn_mark_all_read">Marcar todas como lidas</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Onboarding Modal -->
  <div class="modal-backdrop" id="modalOnboarding">
    <div class="modal" style="max-width:760px">
      <div class="modal-header">
        <strong data-i18n="onboarding_title">Guia de primeiro acesso</strong>
        <button class="btn btn-outline" onclick="closeModal('modalOnboarding')" style="padding:8px">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="hint" style="margin-bottom:12px" data-i18n="onboarding_sub">
          Em 5 minutos você configura seu site e começa a captar leads.
        </div>

        <ol style="padding-left:18px; display:grid; gap:10px">
          <li><strong data-i18n="onboarding_step1_t">Configure seu perfil e cores</strong><br>
              <span data-i18n="onboarding_step1_d">Abra "Perfil & Aparência", escolha cores, WhatsApp e nome do site, e clique em Salvar.</span></li>
          <li><strong data-i18n="onboarding_step2_t">Cadastre um imóvel</strong><br>
              <span data-i18n="onboarding_step2_d">Clique em "Novo Imóvel", adicione fotos e salve. Ele aparece na prévia e no site público.</span></li>
          <li><strong data-i18n="onboarding_step3_t">Cadastre um lead</strong><br>
              <span data-i18n="onboarding_step3_d">Vá em "Leads" e cadastre um contato. Depois teste o botão de WhatsApp.</span></li>
          <li><strong data-i18n="onboarding_step4_t">Abra o site público</strong><br>
              <span data-i18n="onboarding_step4_d">No menu "Site", clique em "Abrir público" para ver o subdomínio/preview.</span></li>
        </ol>

        <div class="hint" style="margin-top:12px" data-i18n="onboarding_hint">
          Dica: se algo "não carregar", confira se você está acessando via URL do Vercel (não abrindo o arquivo direto).
        </div>
      </div>
      <div class="modal-footer" style="display:flex; justify-content:space-between; gap:10px">
        <button class="btn btn-outline" onclick="switchView('profile'); closeModal('modalOnboarding')">
          <i class="fa-solid fa-user-gear"></i> <span data-i18n="onboarding_btn_profile">Ir para Perfil</span>
        </button>
        <div style="display:flex; gap:10px">
          <button class="btn btn-outline" onclick="closeModal('modalOnboarding')">
            <span data-i18n="onboarding_btn_later">Depois</span>
          </button>
          <button class="btn btn-primary" onclick="completeOnboarding()">
            <i class="fa-solid fa-circle-check"></i> <span data-i18n="onboarding_btn_done">Concluir</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ==========================
    // GLOBAL STATE & CONFIG
    // ==========================
    let CRMState = {
      lang: "pt",
      tenant: null,
      user: null,
      properties: [],
      leads: [],
      appointments: [],
      notifications: [],
      currentMonth: new Date().getMonth(),
      currentYear: new Date().getFullYear(),
      _onboardingCompleted: false
    };

    let propertyPhotos = [];
    let searchTimeout = null;

    // ==========================
    // CORE FUNCTIONS - CORRIGIDAS
    // ==========================

    // 1. Helper functions - SEGURAS
    function $(id) { 
      const element = document.getElementById(id);
      if (!element) console.warn(`Elemento não encontrado: #${id}`);
      return element;
    }

    function sanitizeInput(input) {
      if (typeof input !== 'string') return '';
      return input
        .replace(/[<>]/g, '') // Remover tags HTML
        .trim()
        .substring(0, 500); // Limitar tamanho
    }

    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    function formatPhone(phone) {
      const cleaned = phone.replace(/\D/g, '');
      if (cleaned.length === 11) {
        return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 7)}-${cleaned.substring(7)}`;
      } else if (cleaned.length === 10) {
        return `(${cleaned.substring(0, 2)}) ${cleaned.substring(2, 6)}-${cleaned.substring(6)}`;
      }
      return phone;
    }

    function showToast(msg, type = "info") {
      const container = $('toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      // Usar textContent para segurança
      const icon = document.createElement('i');
      icon.className = type === 'success' ? 'fa-solid fa-check-circle' : 
                      type === 'error' ? 'fa-solid fa-exclamation-circle' : 'fa-solid fa-info-circle';
      
      const text = document.createElement('div');
      text.textContent = msg;
      
      const button = document.createElement('button');
      button.className = 'btn btn-outline';
      button.style.cssText = 'padding:4px 8px; margin-left:auto';
      button.innerHTML = '<i class="fa-solid fa-xmark"></i>';
      button.onclick = function() { toast.remove(); };
      
      toast.appendChild(icon);
      toast.appendChild(text);
      toast.appendChild(button);
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => {
          if (toast.parentNode === container) {
            toast.remove();
          }
        }, 300);
      }, 3000);
    }

    function hexToRgba(hex, alpha = 1) {
      if (!hex || !hex.match(/^#?([0-9A-F]{3}){1,2}$/i)) return `rgba(37, 99, 235, ${alpha})`;
      
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function formatCurrency(value) {
      if (isNaN(value)) return 'R$ 0,00';
      return new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
      }).format(value);
    }

    function getSourceLabel(source) {
      const sources = {
        site: 'Site',
        whatsapp: 'WhatsApp',
        instagram: 'Instagram',
        facebook: 'Facebook',
        referral: 'Indicação',
        other: 'Outro'
      };
      return sources[source] || source;
    }

    function getLeadStageLabel(stage) {
      const stages = {
        new: 'Novo',
        contacted: 'Contactado',
        negotiation: 'Negociação',
        converted: 'Convertido',
        lost: 'Perdido'
      };
      return stages[stage] || stage;
    }

    function getLeadStatusClass(stage) {
      const classes = {
        new: 'status-new',
        contacted: 'status-active',
        negotiation: 'status-pending',
        converted: 'status-sold',
        lost: 'status-bad'
      };
      return classes[stage] || 'status-new';
    }

    // 2. Navigation
    function switchView(view) {
      try {
        document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
        const el = $(`view-${view}`);
        if (el) {
          el.classList.add("active");
          el.classList.add("fade-in");
        }

        document.querySelectorAll("#nav button").forEach(b => b.classList.remove("active"));
        const btn = document.querySelector(`#nav button[data-view="${view}"]`);
        if (btn) btn.classList.add("active");

        const content = document.querySelector(".content");
        if (content) {
          content.scrollTo({ top: 0, behavior: "smooth" });
        }

        loadViewData(view);
      } catch (error) {
        console.error('Erro ao trocar view:', error);
        showToast('Erro ao carregar a página', 'error');
      }
    }

    function loadViewData(view) {
      switch(view) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'properties':
          renderProperties();
          break;
        case 'leads':
          renderLeads();
          break;
        case 'site':
          renderSitePreview();
          break;
        case 'calendar':
          renderCalendar();
          break;
        case 'profile':
          loadProfileData();
          break;
        case 'reports':
          renderReports();
          break;
      }
    }

    function toggleSidebar() {
      const sidebar = $("sidebar");
      if (sidebar) {
        sidebar.style.display = sidebar.style.display === 'none' ? 'flex' : 'none';
      }
    }

    // 3. Modal functions - MELHORADAS
    function closeModal(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.style.display = "none";
        document.activeElement.blur(); // Remover foco
      }
    }

    function showModal(modalId) {
      const modal = $(modalId);
      if (modal) {
        modal.style.display = "flex";
        // Focar no primeiro elemento interativo
        const firstInput = modal.querySelector('input, select, textarea, button');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 100);
        }
      }
    }

    // 4. Dashboard functions
    function renderDashboard() {
      updateDashboardMetrics();
      renderPerformanceChart();
      renderRecentLeads();
      renderTodaysFocus();
    }

    function updateDashboardMetrics() {
      try {
        const today = new Date().toISOString().split('T')[0];
        
        // Leads hoje
        const todayLeads = CRMState.leads.filter(l => {
          const leadDate = new Date(l.created_at || Date.now());
          return leadDate.toISOString().split('T')[0] === today;
        }).length;
        
        // Leads este mês
        const monthLeads = CRMState.leads.filter(l => {
          const leadDate = new Date(l.created_at || Date.now());
          return leadDate.getMonth() === new Date().getMonth() && 
                 leadDate.getFullYear() === new Date().getFullYear();
        }).length;
        
        // Visitas totais
        const totalVisits = CRMState.properties.reduce((sum, p) => sum + (p.visits || 0), 0);
        
        // Taxa de conversão
        const convertedLeads = CRMState.leads.filter(l => l.stage === 'converted').length;
        const conversionRate = CRMState.leads.length > 0 ? 
          ((convertedLeads / CRMState.leads.length) * 100).toFixed(1) : '0.0';
        
        // Atualizar UI
        const leadsTodayEl = $("mLeadsToday");
        const leadsMonthEl = $("mLeadsMonth");
        const siteVisitsEl = $("mSiteVisits");
        const conversionEl = $("mConversion");
        
        if (leadsTodayEl) leadsTodayEl.textContent = todayLeads;
        if (leadsMonthEl) leadsMonthEl.textContent = monthLeads;
        if (siteVisitsEl) siteVisitsEl.textContent = totalVisits;
        if (conversionEl) conversionEl.textContent = `${conversionRate}%`;
        
        // Atualizar badges
        updateBadges();
        
      } catch (error) {
        console.error('Erro ao atualizar métricas:', error);
      }
    }

    function updateBadges() {
      try {
        const badgeProps = $("badgeProperties");
        const badgeLeads = $("badgeLeads");
        const badgeDashboard = $("badgeDashboard");
        const badgeCalendar = $("badgeCalendar");
        const notificationCount = $("notificationCount");
        const propertiesCount = $("propertiesCount");
        const leadsCount = $("leadsCount");
        
        if (badgeProps) badgeProps.textContent = CRMState.properties.length;
        if (badgeLeads) badgeLeads.textContent = CRMState.leads.length;
        
        // Notificações não lidas
        const unreadNotifications = CRMState.notifications.filter(n => !n.read).length;
        if (notificationCount) notificationCount.textContent = unreadNotifications;
        if (badgeDashboard) badgeDashboard.textContent = unreadNotifications;
        
        // Compromissos de hoje
        const today = new Date().toISOString().split('T')[0];
        const todayAppointments = CRMState.appointments.filter(a => {
          const apptDate = new Date(a.start_at || Date.now());
          return apptDate.toISOString().split('T')[0] === today;
        }).length;
        if (badgeCalendar) badgeCalendar.textContent = todayAppointments;
        
        // Atualizar contadores
        if (propertiesCount) propertiesCount.textContent = CRMState.properties.length;
        if (leadsCount) leadsCount.textContent = CRMState.leads.length;
      } catch (error) {
        console.error('Erro ao atualizar badges:', error);
      }
    }

    function renderPerformanceChart() {
      const ctx = $("performanceChart");
      if (!ctx) return;
      
      // Destruir gráfico anterior se existir
      if (window.performanceChart && typeof window.performanceChart.destroy === 'function') {
        try {
          window.performanceChart.destroy();
        } catch (e) {
          console.warn('Erro ao destruir gráfico anterior:', e);
        }
      }
      
      // Gerar dados para demonstração
      const labels = [];
      const leadsData = [];
      const conversionData = [];
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dayName = date.toLocaleDateString('pt-BR', { weekday: 'short' });
        labels.push(dayName);
        
        const dayLeads = CRMState.leads.filter(l => {
          const leadDate = new Date(l.created_at || Date.now());
          return leadDate.toISOString().split('T')[0] === date.toISOString().split('T')[0];
        }).length;
        
        leadsData.push(dayLeads);
        conversionData.push(Math.floor(dayLeads * 0.3)); // 30% de conversão
      }
      
      try {
        window.performanceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Leads',
                data: leadsData,
                borderColor: CRMState.tenant?.primary_color || '#2563eb',
                backgroundColor: hexToRgba(CRMState.tenant?.primary_color || '#2563eb', 0.1),
                tension: 0.4,
                fill: true
              },
              {
                label: 'Conversões',
                data: conversionData,
                borderColor: CRMState.tenant?.secondary_color || '#0ea5e9',
                backgroundColor: hexToRgba(CRMState.tenant?.secondary_color || '#0ea5e9', 0.1),
                tension: 0.4,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Erro ao criar gráfico:', error);
      }
    }

    function renderRecentLeads() {
      const tbody = $("recentLeadsTbody");
      if (!tbody) return;
      
      try {
        const recentLeads = CRMState.leads.sort((a, b) => 
          new Date(b.created_at) - new Date(a.created_at)
        ).slice(0, 5);
        
        if (recentLeads.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align:center; padding:40px; color:var(--muted)">
                <i class="fa-solid fa-users" style="font-size:24px; margin-bottom:12px"></i>
                <div>Nenhum lead cadastrado ainda</div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = recentLeads.map(lead => `
          <tr>
            <td>${sanitizeInput(lead.name)}</td>
            <td>${sanitizeInput(lead.interest || 'Não informado')}</td>
            <td>${getSourceLabel(lead.source)}</td>
            <td>
              <span class="status-badge ${getLeadStatusClass(lead.stage)}">
                ${getLeadStageLabel(lead.stage)}
              </span>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Erro ao renderizar leads recentes:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="4" style="text-align:center; padding:20px; color:var(--bad)">
              Erro ao carregar leads
            </td>
          </tr>
        `;
      }
    }

    function renderTodaysFocus() {
      const container = $("todaysFocus");
      if (!container) return;
      
      try {
        const today = new Date().toISOString().split('T')[0];
        const tasks = [];
        
        // 1. Compromissos de hoje
        const todaysAppointments = CRMState.appointments.filter(a => {
          const apptDate = new Date(a.start_at || Date.now());
          return apptDate.toISOString().split('T')[0] === today && a.status !== 'cancelled';
        });
        
        if (todaysAppointments.length > 0) {
          tasks.push({
            title: `Você tem ${todaysAppointments.length} compromisso(s) hoje`,
            priority: 'high',
            icon: 'fa-regular fa-clock',
            action: () => switchView('calendar')
          });
        }
        
        // 2. Leads novos não contactados
        const newLeads = CRMState.leads.filter(l => l.stage === 'new');
        if (newLeads.length > 0) {
          tasks.push({
            title: `${newLeads.length} lead(s) novo(s) aguardando contato`,
            priority: 'high',
            icon: 'fa-solid fa-user-plus',
            action: () => switchView('leads')
          });
        }
        
        // 3. Imóveis sem fotos
        const propertiesWithoutPhotos = CRMState.properties.filter(p => 
          !p.images || p.images.length === 0
        );
        if (propertiesWithoutPhotos.length > 0) {
          tasks.push({
            title: `${propertiesWithoutPhotos.length} imóvel(is) sem fotos`,
            priority: 'medium',
            icon: 'fa-regular fa-image',
            action: () => switchView('properties')
          });
        }
        
        // 4. Leads em negociação
        const negotiationLeads = CRMState.leads.filter(l => l.stage === 'negotiation');
        if (negotiationLeads.length > 0) {
          tasks.push({
            title: `${negotiationLeads.length} lead(s) em negociação`,
            priority: 'high',
            icon: 'fa-solid fa-handshake',
            action: () => switchView('leads')
          });
        }
        
        // Se não houver tarefas
        if (tasks.length === 0) {
          tasks.push({
            title: 'Tudo em dia! Continue o bom trabalho.',
            priority: 'none',
            icon: 'fa-solid fa-check-circle',
            action: () => showToast('Tudo sob controle!', 'success')
          });
        }
        
        // Limitar a 3 tarefas
        const displayTasks = tasks.slice(0, 3);
        
        container.innerHTML = displayTasks.map(task => `
          <div class="kanban-card" onclick="(${task.action.toString().replace(/\n/g, ' ')})()">
            <div class="kanban-card-title">${sanitizeInput(task.title)}</div>
            <div class="kanban-card-meta">
              <span><i class="${task.icon}"></i> ${task.priority === 'high' ? 'Alta' : task.priority === 'medium' ? 'Média' : 'Baixa'} prioridade</span>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao renderizar foco do dia:', error);
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--bad)">
            Erro ao carregar tarefas
          </div>
        `;
      }
    }

    // 5. Properties functions - CORRIGIDAS
    function showNewPropertyModal() {
      showModal('modalNewProperty');
      const form = $("propertyForm");
      if (form) form.reset();
      propertyPhotos = [];
      updatePropertyPhotoPreview();
      
      // Restaurar título e botão padrão
      const title = document.querySelector('#modalNewProperty .modal-header strong');
      if (title) title.textContent = 'Cadastrar Novo Imóvel';
      
      const saveBtn = document.querySelector('#modalNewProperty .modal-footer .btn-primary');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> <span>Salvar Imóvel</span>';
        saveBtn.onclick = function() { saveProperty(); };
      }
    }

    function handlePropertyPhotos(event) {
      const files = Array.from(event.target.files);
      const validFiles = files.filter(file => 
        file.type.startsWith('image/') && file.size <= 5 * 1024 * 1024
      );
      
      validFiles.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          propertyPhotos.push(e.target.result);
          updatePropertyPhotoPreview();
        };
        reader.onerror = () => {
          showToast('Erro ao ler imagem', 'error');
        };
        reader.readAsDataURL(file);
      });
      
      if (validFiles.length < files.length) {
        showToast('Algumas imagens foram ignoradas (tamanho máximo: 5MB)', 'warning');
      }
    }

    function updatePropertyPhotoPreview() {
      const preview = $("propertyPhotoPreview");
      if (!preview) return;
      
      preview.innerHTML = '';
      
      propertyPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'photo-preview-item';
        item.innerHTML = `
          <img src="${photo}" alt="Foto ${index + 1}">
          <button onclick="removePropertyPhoto(${index})">
            <i class="fa-solid fa-xmark"></i>
          </button>
        `;
        preview.appendChild(item);
      });
    }

    function removePropertyPhoto(index) {
      if (index >= 0 && index < propertyPhotos.length) {
        propertyPhotos.splice(index, 1);
        updatePropertyPhotoPreview();
      }
    }

    function saveProperty() {
      try {
        const title = sanitizeInput($("propertyTitle").value.trim());
        const type = $("propertyType").value;
        const address = sanitizeInput($("propertyAddress").value.trim());
        const city = sanitizeInput($("propertyCity").value.trim());
        const price = parseFloat($("propertyPrice").value);
        const description = sanitizeInput($("propertyDescription").value.trim());
        
        if (!title || !type || !address || !city || !price || !description) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        if (isNaN(price) || price <= 0) {
          showToast('Preço inválido!', 'error');
          $("propertyPrice").classList.add('input-error');
          return;
        }
        
        if (propertyPhotos.length === 0) {
          showToast('Adicione pelo menos uma foto do imóvel!', 'error');
          return;
        }
        
        const property = {
          id: Date.now(),
          title,
          type,
          address,
          city,
          price,
          area: $("propertyArea").value ? parseFloat($("propertyArea").value) : null,
          bedrooms: $("propertyBedrooms").value ? parseInt($("propertyBedrooms").value) : null,
          bathrooms: $("propertyBathrooms").value ? parseInt($("propertyBathrooms").value) : null,
          description,
          images: [...propertyPhotos], // Copiar array
          status: 'active',
          visits: 0,
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        CRMState.properties.push(property);
        
        saveToLocalStorage();
        
        showToast('Imóvel cadastrado com sucesso!', 'success');
        closeModal('modalNewProperty');
        renderProperties();
        updateDashboardMetrics();
        renderSitePreview();
        
      } catch (error) {
        console.error('Erro ao salvar imóvel:', error);
        showToast('Erro ao cadastrar imóvel', 'error');
      }
    }

    function renderProperties() {
      const countEl = $("propertiesCount");
      if (countEl) countEl.textContent = CRMState.properties.length;
      
      // Render kanban
      const kanban = $("propertiesKanban");
      if (kanban) {
        try {
          const statuses = [
            { id: 'draft', title: 'Rascunho', color: '#64748b' },
            { id: 'active', title: 'Ativo', color: '#10b981' },
            { id: 'reserved', title: 'Reservado', color: '#f59e0b' },
            { id: 'sold', title: 'Vendido', color: '#ef4444' },
            { id: 'archived', title: 'Arquivado', color: '#6b7280' }
          ];
          
          kanban.innerHTML = statuses.map(status => {
            const props = CRMState.properties.filter(p => p.status === status.id);
            return `
              <div class="kanban-column">
                <div class="kanban-header">
                  <span>${status.title}</span>
                  <span class="badge">${props.length}</span>
                </div>
                <div class="kanban-body" data-status="${status.id}">
                  ${props.length === 0 ? `
                    <div style="text-align:center; padding:20px; color:var(--muted)">
                      <i class="fa-solid fa-house" style="font-size:24px; margin-bottom:8px"></i>
                      <div>Nenhum imóvel</div>
                    </div>
                  ` : props.map(prop => `
                    <div class="kanban-card" draggable="true" data-id="${prop.id}" onclick="editProperty(${prop.id})">
                      <div class="kanban-card-title">${sanitizeInput(prop.title)}</div>
                      <div class="kanban-card-meta">
                        <span><i class="fa-solid fa-location-dot"></i> ${sanitizeInput(prop.city)}</span>
                        <span><i class="fa-solid fa-money-bill"></i> ${formatCurrency(prop.price)}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('');
          
          initPropertyDragAndDrop();
        } catch (error) {
          console.error('Erro ao renderizar kanban:', error);
          kanban.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--bad); grid-column:1/-1">
              Erro ao carregar imóveis
            </div>
          `;
        }
      }
      
      // Render tabela
      const tbody = $("propertiesTbody");
      if (tbody) {
        try {
          if (CRMState.properties.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align:center; padding:40px; color:var(--muted)">
                  <i class="fa-solid fa-house" style="font-size:32px; margin-bottom:12px"></i>
                  <div>Nenhum imóvel cadastrado ainda</div>
                  <button class="btn btn-primary" style="margin-top:16px" onclick="showNewPropertyModal()">
                    <i class="fa-solid fa-plus"></i> Cadastrar primeiro imóvel
                  </button>
                </td>
              </tr>
            `;
          } else {
            tbody.innerHTML = CRMState.properties.map(prop => `
              <tr>
                <td><strong>${sanitizeInput(prop.title)}</strong></td>
                <td>${prop.type === 'apartment' ? 'Apartamento' : 
                      prop.type === 'house' ? 'Casa' : 
                      prop.type === 'commercial' ? 'Comercial' : 'Terreno'}</td>
                <td>${sanitizeInput(prop.city)}</td>
                <td>${formatCurrency(prop.price)}</td>
                <td>
                  <span class="status-badge ${prop.status === 'active' ? 'status-active' : 
                                           prop.status === 'sold' ? 'status-sold' : 
                                           prop.status === 'reserved' ? 'status-pending' : 'status-new'}">
                    ${prop.status === 'active' ? 'Ativo' : 
                      prop.status === 'sold' ? 'Vendido' : 
                      prop.status === 'reserved' ? 'Reservado' : 'Rascunho'}
                  </span>
                </td>
                <td>${prop.visits || 0}</td>
                <td>
                  <button class="btn btn-outline" style="padding:8px 12px" onclick="editProperty(${prop.id})">
                    <i class="fa-solid fa-pen"></i>
                  </button>
                  <button class="btn btn-outline" style="padding:8px 12px" onclick="deleteProperty(${prop.id})">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </td>
              </tr>
            `).join('');
          }
        } catch (error) {
          console.error('Erro ao renderizar tabela:', error);
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align:center; padding:20px; color:var(--bad)">
                Erro ao carregar dados
              </td>
            </tr>
          `;
        }
      }
    }

    function initPropertyDragAndDrop() {
      const columns = document.querySelectorAll('.kanban-body');
      
      columns.forEach(column => {
        column.addEventListener('dragover', (e) => {
          e.preventDefault();
          column.classList.add('drag-over');
        });
        
        column.addEventListener('dragleave', () => {
          column.classList.remove('drag-over');
        });
        
        column.addEventListener('drop', (e) => {
          e.preventDefault();
          column.classList.remove('drag-over');
          
          const propertyId = e.dataTransfer.getData('text/plain');
          const newStatus = column.dataset.status;
          
          if (!propertyId || !newStatus) return;
          
          const propertyIndex = CRMState.properties.findIndex(p => p.id == propertyId);
          if (propertyIndex !== -1) {
            CRMState.properties[propertyIndex].status = newStatus;
            CRMState.properties[propertyIndex].updated_at = new Date().toISOString();
            
            saveToLocalStorage();
            renderProperties();
            showToast('Status do imóvel atualizado!', 'success');
          }
        });
      });
      
      // Event delegation para dragstart
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('kanban-card')) {
          e.dataTransfer.setData('text/plain', e.target.dataset.id);
          e.target.classList.add('dragging');
        }
      }, true);
      
      document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('kanban-card')) {
          e.target.classList.remove('dragging');
        }
      }, true);
    }

    function editProperty(id) {
      const property = CRMState.properties.find(p => p.id == id);
      if (!property) return;
      
      $("propertyTitle").value = property.title;
      $("propertyType").value = property.type;
      $("propertyAddress").value = property.address;
      $("propertyCity").value = property.city;
      $("propertyPrice").value = property.price;
      $("propertyArea").value = property.area || '';
      $("propertyBedrooms").value = property.bedrooms || '';
      $("propertyBathrooms").value = property.bathrooms || '';
      $("propertyDescription").value = property.description;
      
      propertyPhotos = property.images ? [...property.images] : [];
      updatePropertyPhotoPreview();
      
      showModal('modalNewProperty');
      
      // Alterar título do modal
      const title = document.querySelector('#modalNewProperty .modal-header strong');
      if (title) title.textContent = 'Editar Imóvel';
      
      // Alterar botão de salvar
      const saveBtn = document.querySelector('#modalNewProperty .modal-footer .btn-primary');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> <span>Atualizar Imóvel</span>';
        saveBtn.onclick = function() { updateProperty(id); };
      }
    }

    function updateProperty(id) {
      try {
        const propertyIndex = CRMState.properties.findIndex(p => p.id == id);
        if (propertyIndex === -1) {
          showToast('Imóvel não encontrado', 'error');
          return;
        }
        
        const title = sanitizeInput($("propertyTitle").value.trim());
        const type = $("propertyType").value;
        const address = sanitizeInput($("propertyAddress").value.trim());
        const city = sanitizeInput($("propertyCity").value.trim());
        const price = parseFloat($("propertyPrice").value);
        const description = sanitizeInput($("propertyDescription").value.trim());
        
        if (!title || !type || !address || !city || !price || !description) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        if (isNaN(price) || price <= 0) {
          showToast('Preço inválido!', 'error');
          return;
        }
        
        CRMState.properties[propertyIndex] = {
          ...CRMState.properties[propertyIndex],
          title,
          type,
          address,
          city,
          price,
          area: $("propertyArea").value ? parseFloat($("propertyArea").value) : null,
          bedrooms: $("propertyBedrooms").value ? parseInt($("propertyBedrooms").value) : null,
          bathrooms: $("propertyBathrooms").value ? parseInt($("propertyBathrooms").value) : null,
          description,
          images: [...propertyPhotos], // Copiar array
          updated_at: new Date().toISOString()
        };
        
        saveToLocalStorage();
        
        showToast('Imóvel atualizado com sucesso!', 'success');
        closeModal('modalNewProperty');
        renderProperties();
        renderSitePreview();
        
      } catch (error) {
        console.error('Erro ao atualizar imóvel:', error);
        showToast('Erro ao atualizar imóvel', 'error');
      }
    }

    function deleteProperty(id) {
      if (confirm('Tem certeza que deseja excluir este imóvel?')) {
        CRMState.properties = CRMState.properties.filter(p => p.id != id);
        saveToLocalStorage();
        renderProperties();
        updateDashboardMetrics();
        renderSitePreview();
        showToast('Imóvel excluído com sucesso!', 'success');
      }
    }

    function exportProperties() {
      try {
        const dataStr = JSON.stringify(CRMState.properties, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const exportFileDefaultName = `imoveis_${new Date().toISOString().split('T')[0]}.json`;
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        
        showToast('Exportação concluída!', 'success');
      } catch (error) {
        console.error('Erro ao exportar:', error);
        showToast('Erro ao exportar dados', 'error');
      }
    }

    function exportPropertiesCSV() {
      try {
        const csvContent = "data:text/csv;charset=utf-8," 
          + "Título,Tipo,Endereço,Cidade,Preço,Área,Quartos,Banheiros,Status,Visitas,Data Cadastro\n"
          + CRMState.properties.map(prop => 
              `"${prop.title.replace(/"/g, '""')}","${prop.type}","${prop.address.replace(/"/g, '""')}","${prop.city.replace(/"/g, '""')}","${prop.price}","${prop.area || ''}","${prop.bedrooms || ''}","${prop.bathrooms || ''}","${prop.status}","${prop.visits || 0}","${new Date(prop.created_at).toLocaleDateString('pt-BR')}"`
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `imoveis_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Imóveis exportados em CSV!', 'success');
      } catch (error) {
        console.error('Erro ao exportar CSV:', error);
        showToast('Erro ao exportar CSV', 'error');
      }
    }

    // 6. Leads functions - CORRIGIDAS
    function showNewLeadModal() {
      showModal('modalNewLead');
      const form = $("leadForm");
      if (form) form.reset();
      
      // Restaurar título e botão padrão
      const title = document.querySelector('#modalNewLead .modal-header strong');
      if (title) title.textContent = 'Cadastrar Novo Lead';
      
      const saveBtn = document.querySelector('#modalNewLead .modal-footer .btn-primary');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> <span>Salvar Lead</span>';
        saveBtn.onclick = function() { saveLead(); };
      }
    }

    function saveLead() {
      try {
        const name = sanitizeInput($("leadName").value.trim());
        const phone = $("leadPhone").value.trim();
        const source = $("leadSource").value;
        const interest = $("leadInterest").value;
        
        if (!name || !phone || !source || !interest) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        const email = $("leadEmail").value.trim();
        if (email && !isValidEmail(email)) {
          showToast('Email inválido!', 'error');
          $("leadEmail").classList.add('input-error');
          return;
        }
        
        const lead = {
          id: Date.now(),
          name,
          email: email || '',
          phone: formatPhone(phone),
          source,
          interest,
          budget: $("leadBudget").value ? parseFloat($("leadBudget").value) : null,
          notes: sanitizeInput($("leadNotes").value.trim()),
          stage: 'new',
          created_at: new Date().toISOString(),
          last_contact: new Date().toISOString()
        };
        
        CRMState.leads.push(lead);
        
        // Adicionar notificação
        CRMState.notifications.unshift({
          id: Date.now(),
          title: 'Novo lead cadastrado',
          message: `${name} se interessou por ${interest}`,
          type: 'lead',
          read: false,
          created_at: new Date().toISOString()
        });
        
        saveToLocalStorage();
        
        showToast('Lead cadastrado com sucesso!', 'success');
        closeModal('modalNewLead');
        renderLeads();
        updateDashboardMetrics();
        
      } catch (error) {
        console.error('Erro ao salvar lead:', error);
        showToast('Erro ao cadastrar lead', 'error');
      }
    }

    function renderLeads() {
      const countEl = $("leadsCount");
      if (countEl) countEl.textContent = CRMState.leads.length;
      
      // Render kanban
      const kanban = $("leadsKanban");
      if (kanban) {
        try {
          const stages = [
            { id: 'new', title: 'Novo', color: '#3b82f6' },
            { id: 'contacted', title: 'Contactado', color: '#0ea5e9' },
            { id: 'negotiation', title: 'Negociação', color: '#f59e0b' },
            { id: 'converted', title: 'Convertido', color: '#10b981' },
            { id: 'lost', title: 'Perdido', color: '#ef4444' }
          ];
          
          kanban.innerHTML = stages.map(stage => {
            const stageLeads = CRMState.leads.filter(l => l.stage === stage.id);
            return `
              <div class="kanban-column">
                <div class="kanban-header">
                  <span>${stage.title}</span>
                  <span class="badge">${stageLeads.length}</span>
                </div>
                <div class="kanban-body" data-stage="${stage.id}">
                  ${stageLeads.length === 0 ? `
                    <div style="text-align:center; padding:20px; color:var(--muted)">
                      <i class="fa-solid fa-user" style="font-size:24px; margin-bottom:8px"></i>
                      <div>Nenhum lead</div>
                    </div>
                  ` : stageLeads.map(lead => `
                    <div class="kanban-card" draggable="true" data-id="${lead.id}" onclick="editLead(${lead.id})">
                      <div class="kanban-card-title">${sanitizeInput(lead.name)}</div>
                      <div class="kanban-card-meta">
                        <span><i class="fa-solid fa-phone"></i> ${lead.phone}</span>
                        <span><i class="fa-solid fa-home"></i> ${lead.interest}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }).join('');
          
          initLeadDragAndDrop();
        } catch (error) {
          console.error('Erro ao renderizar kanban de leads:', error);
          kanban.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--bad); grid-column:1/-1">
              Erro ao carregar leads
            </div>
          `;
        }
      }
      
      // Render tabela
      const tbody = $("leadsTbody");
      if (tbody) {
        try {
          if (CRMState.leads.length === 0) {
            tbody.innerHTML = `
              <tr>
                <td colspan="7" style="text-align:center; padding:40px; color:var(--muted)">
                  <i class="fa-solid fa-users" style="font-size:32px; margin-bottom:12px"></i>
                  <div>Nenhum lead cadastrado ainda</div>
                  <button class="btn btn-primary" style="margin-top:16px" onclick="showNewLeadModal()">
                    <i class="fa-solid fa-plus"></i> Cadastrar primeiro lead
                  </button>
                </td>
              </tr>
            `;
          } else {
            tbody.innerHTML = CRMState.leads.map(lead => {
              const lastActivity = new Date(lead.last_contact || lead.created_at);
              const formattedDate = lastActivity.toLocaleDateString('pt-BR');
              
              return `
                <tr>
                  <td><strong>${sanitizeInput(lead.name)}</strong></td>
                  <td>
                    <div>${lead.phone}</div>
                    <div style="font-size:12px; color:var(--muted)">${lead.email || ''}</div>
                  </td>
                  <td>${lead.interest}</td>
                  <td>${getSourceLabel(lead.source)}</td>
                  <td>
                    <span class="status-badge ${getLeadStatusClass(lead.stage)}">
                      ${getLeadStageLabel(lead.stage)}
                    </span>
                  </td>
                  <td>${formattedDate}</td>
                  <td>
                    <button class="btn btn-outline" style="padding:8px 12px" onclick="editLead(${lead.id})">
                      <i class="fa-solid fa-pen"></i>
                    </button>
                    <button class="btn btn-outline" style="padding:8px 12px" onclick="contactLead(${lead.id})">
                      <i class="fa-solid fa-phone"></i>
                    </button>
                  </td>
                </tr>
              `;
            }).join('');
          }
        } catch (error) {
          console.error('Erro ao renderizar tabela de leads:', error);
          tbody.innerHTML = `
            <tr>
              <td colspan="7" style="text-align:center; padding:20px; color:var(--bad)">
                Erro ao carregar dados
              </td>
            </tr>
          `;
        }
      }
    }

    function initLeadDragAndDrop() {
      const columns = document.querySelectorAll('.kanban-body');
      
      columns.forEach(column => {
        column.addEventListener('dragover', (e) => {
          e.preventDefault();
          column.classList.add('drag-over');
        });
        
        column.addEventListener('dragleave', () => {
          column.classList.remove('drag-over');
        });
        
        column.addEventListener('drop', (e) => {
          e.preventDefault();
          column.classList.remove('drag-over');
          
          const leadId = e.dataTransfer.getData('text/plain');
          const newStage = column.dataset.stage;
          
          if (!leadId || !newStage) return;
          
          const leadIndex = CRMState.leads.findIndex(l => l.id == leadId);
          if (leadIndex !== -1) {
            CRMState.leads[leadIndex].stage = newStage;
            CRMState.leads[leadIndex].last_contact = new Date().toISOString();
            
            saveToLocalStorage();
            renderLeads();
            updateDashboardMetrics();
            showToast('Stage do lead atualizado!', 'success');
          }
        });
      });
      
      // Event delegation para dragstart
      document.addEventListener('dragstart', (e) => {
        if (e.target.classList.contains('kanban-card')) {
          e.dataTransfer.setData('text/plain', e.target.dataset.id);
          e.target.classList.add('dragging');
        }
      }, true);
      
      document.addEventListener('dragend', (e) => {
        if (e.target.classList.contains('kanban-card')) {
          e.target.classList.remove('dragging');
        }
      }, true);
    }

    function editLead(id) {
      const lead = CRMState.leads.find(l => l.id == id);
      if (!lead) return;
      
      $("leadName").value = lead.name;
      $("leadEmail").value = lead.email || '';
      $("leadPhone").value = lead.phone;
      $("leadSource").value = lead.source;
      $("leadInterest").value = lead.interest;
      $("leadBudget").value = lead.budget || '';
      $("leadNotes").value = lead.notes || '';
      
      showModal('modalNewLead');
      
      // Alterar título do modal
      const title = document.querySelector('#modalNewLead .modal-header strong');
      if (title) title.textContent = 'Editar Lead';
      
      // Alterar botão de salvar
      const saveBtn = document.querySelector('#modalNewLead .modal-footer .btn-primary');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> <span>Atualizar Lead</span>';
        saveBtn.onclick = function() { updateLead(id); };
      }
    }

    function updateLead(id) {
      try {
        const leadIndex = CRMState.leads.findIndex(l => l.id == id);
        if (leadIndex === -1) {
          showToast('Lead não encontrado', 'error');
          return;
        }
        
        const name = sanitizeInput($("leadName").value.trim());
        const phone = $("leadPhone").value.trim();
        const source = $("leadSource").value;
        const interest = $("leadInterest").value;
        
        if (!name || !phone || !source || !interest) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        const email = $("leadEmail").value.trim();
        if (email && !isValidEmail(email)) {
          showToast('Email inválido!', 'error');
          return;
        }
        
        CRMState.leads[leadIndex] = {
          ...CRMState.leads[leadIndex],
          name,
          email: email || '',
          phone: formatPhone(phone),
          source,
          interest,
          budget: $("leadBudget").value ? parseFloat($("leadBudget").value) : null,
          notes: sanitizeInput($("leadNotes").value.trim()),
          last_contact: new Date().toISOString()
        };
        
        saveToLocalStorage();
        
        showToast('Lead atualizado com sucesso!', 'success');
        closeModal('modalNewLead');
        renderLeads();
        updateDashboardMetrics();
        
      } catch (error) {
        console.error('Erro ao atualizar lead:', error);
        showToast('Erro ao atualizar lead', 'error');
      }
    }

    function contactLead(id) {
      const lead = CRMState.leads.find(l => l.id == id);
      if (!lead) {
        showToast('Lead não encontrado', 'error');
        return;
      }
      
      try {
        const whatsappNumber = lead.phone.replace(/\D/g, '');
        if (!whatsappNumber) {
          showToast('Número de telefone inválido', 'error');
          return;
        }
        
        const message = `Olá ${lead.name}, tudo bem? Aqui é o corretor ${CRMState.user?.name || ''}. Gostaria de conversar sobre imóveis!`;
        
        const url = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
        
        lead.last_contact = new Date().toISOString();
        lead.stage = 'contacted';
        saveToLocalStorage();
        renderLeads();
        updateDashboardMetrics();
        
        showToast('Conversa iniciada no WhatsApp!', 'success');
      } catch (error) {
        console.error('Erro ao contactar lead:', error);
        showToast('Erro ao abrir WhatsApp', 'error');
      }
    }

    function exportLeads() {
      try {
        const csvContent = "data:text/csv;charset=utf-8," 
          + "Nome,Email,Telefone,Origem,Interesse,Orçamento,Status,Data Cadastro,Último Contato\n"
          + CRMState.leads.map(lead => 
              `"${lead.name.replace(/"/g, '""')}","${lead.email || ''}","${lead.phone}","${getSourceLabel(lead.source)}","${lead.interest}","${lead.budget || ''}","${getLeadStageLabel(lead.stage)}","${new Date(lead.created_at).toLocaleDateString('pt-BR')}","${new Date(lead.last_contact).toLocaleDateString('pt-BR')}"`
            ).join("\n");
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `leads_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast('Leads exportados com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao exportar leads:', error);
        showToast('Erro ao exportar leads', 'error');
      }
    }

    function importLeads() {
      showToast('Funcionalidade de importação em desenvolvimento', 'info');
    }

    // 7. Site functions
    function renderSitePreview() {
      try {
        const tenant = CRMState.tenant;
        
        const logoText = $("siteLogoText");
        const logoText2 = $("siteLogoText2");
        const heroTitle = $("siteHeroTitle");
        const heroTitle2 = $("siteHeroTitle2");
        const heroSub = $("siteHeroSub");
        const heroSub2 = $("siteHeroSub2");
        
        if (logoText) logoText.textContent = tenant?.site_name || 'Seu Site Imobiliário';
        if (logoText2) logoText2.textContent = tenant?.site_name || 'Seu Site Imobiliário';
        
        if (tenant?.bio) {
          const bio = sanitizeInput(tenant.bio);
          const titlePart = bio.split('.')[0] || bio;
          
          if (heroTitle) heroTitle.textContent = titlePart;
          if (heroTitle2) heroTitle2.textContent = titlePart;
          if (heroSub) heroSub.textContent = bio.length > 100 ? bio.substring(0, 100) + '...' : bio;
          if (heroSub2) heroSub2.textContent = bio.length > 100 ? bio.substring(0, 100) + '...' : bio;
        }
        
        const siteCards = $("siteCards");
        if (siteCards) {
          const activeProperties = CRMState.properties.filter(p => p.status === 'active').slice(0, 6);
          
          if (activeProperties.length === 0) {
            siteCards.innerHTML = `
              <div style="text-align:center; padding:40px; color:var(--muted); grid-column:1/-1">
                <i class="fa-solid fa-house" style="font-size:48px; margin-bottom:16px"></i>
                <div>Cadastre seu primeiro imóvel para aparecer aqui</div>
              </div>
            `;
          } else {
            siteCards.innerHTML = activeProperties.map(prop => `
              <div class="pCard" onclick="showPropertyDetail(${prop.id})">
                <div class="pImg">
                  ${prop.images && prop.images.length > 0 ? 
                    `<img src="${prop.images[0]}" alt="${sanitizeInput(prop.title)}">` : 
                    `<div style="width:100%; height:100%; display:grid; place-items:center; color:white;">
                      <i class="fa-solid fa-house" style="font-size:36px"></i>
                    </div>`
                  }
                </div>
                <div class="pBody">
                  <strong>${sanitizeInput(prop.title.length > 40 ? prop.title.substring(0, 40) + '...' : prop.title)}</strong>
                  <span>${sanitizeInput(prop.city)} • ${formatCurrency(prop.price)}</span>
                </div>
              </div>
            `).join('');
          }
        }
        
        updateSiteColors();
      } catch (error) {
        console.error('Erro ao renderizar preview do site:', error);
      }
    }

    function updateSiteColors() {
      const tenant = CRMState.tenant;
      if (!tenant) return;
      
      const root = document.documentElement;
      
      if (tenant.primary_color && tenant.primary_color.match(/^#?([0-9A-F]{3}){1,2}$/i)) {
        const primary = tenant.primary_color.startsWith('#') ? tenant.primary_color : '#' + tenant.primary_color;
        root.style.setProperty('--primary', primary);
        root.style.setProperty('--primary-light', lightenColor(primary, 20));
        root.style.setProperty('--primary-dark', darkenColor(primary, 20));
      }
      
      if (tenant.secondary_color && tenant.secondary_color.match(/^#?([0-9A-F]{3}){1,2}$/i)) {
        const secondary = tenant.secondary_color.startsWith('#') ? tenant.secondary_color : '#' + tenant.secondary_color;
        root.style.setProperty('--secondary', secondary);
      }
    }

    function lightenColor(color, percent) {
      try {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.min(255, (num >> 16) + amt);
        const G = Math.min(255, (num >> 8 & 0x00FF) + amt);
        const B = Math.min(255, (num & 0x0000FF) + amt);
        
        return "#" + (
          0x1000000 +
          (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
          (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
          (B < 255 ? B < 1 ? 0 : B : 255)
        ).toString(16).slice(1);
      } catch (e) {
        return "#3b82f6";
      }
    }

    function darkenColor(color, percent) {
      try {
        const num = parseInt(color.replace("#", ""), 16);
        const amt = Math.round(2.55 * percent);
        const R = Math.max(0, (num >> 16) - amt);
        const G = Math.max(0, (num >> 8 & 0x00FF) - amt);
        const B = Math.max(0, (num & 0x0000FF) - amt);
        
        return "#" + (
          0x1000000 +
          (R > 0 ? R : 0) * 0x10000 +
          (G > 0 ? G : 0) * 0x100 +
          (B > 0 ? B : 0)
        ).toString(16).slice(1);
      } catch (e) {
        return "#1d4ed8";
      }
    }

    function showPropertyDetail(id) {
      const property = CRMState.properties.find(p => p.id == id);
      if (!property) return;
      
      // Incrementar visitas
      property.visits = (property.visits || 0) + 1;
      saveToLocalStorage();
      updateDashboardMetrics();
      
      showToast(`Visualizando ${sanitizeInput(property.title)}`, 'info');
    }

    function openPublicSite() {
      const tenant = CRMState.tenant;
      if (tenant?.site_name) {
        const siteUrl = `https://${tenant.site_name.toLowerCase().replace(/\s+/g, '-')}.imobipro.app`;
        showToast(`Abrindo site: ${siteUrl}`, 'info');
        window.open(siteUrl, '_blank');
      } else {
        showToast('Configure o nome do site primeiro!', 'warning');
        switchView('profile');
      }
    }

    // 8. Profile functions
    function loadProfileData() {
      try {
        const tenant = CRMState.tenant;
        const user = CRMState.user;
        
        if (tenant) {
          $("fBrokerName").value = tenant.broker_name || '';
          $("fCreci").value = tenant.creci || '';
          $("fWhatsapp").value = tenant.whatsapp || '';
          $("fSiteName").value = tenant.site_name || '';
          $("fPrimary").value = tenant.primary_color || '#2563eb';
          $("fPrimaryText").value = tenant.primary_color || '#2563eb';
          $("fSecondary").value = tenant.secondary_color || '#0ea5e9';
          $("fSecondaryText").value = tenant.secondary_color || '#0ea5e9';
          $("fBio").value = tenant.bio || '';
        }
        
        if (user) {
          const userName = $("userName");
          const userRole = $("userRole");
          const avatarInitials = $("avatarInitials");
          
          if (userName) userName.textContent = user.name || 'Usuário';
          if (userRole) userRole.textContent = user.role || 'Corretor';
          if (avatarInitials) avatarInitials.textContent = getInitials(user.name || 'U');
        }
        
        setupColorPickers();
        updateProfilePreview();
      } catch (error) {
        console.error('Erro ao carregar dados do perfil:', error);
      }
    }

    function getInitials(name) {
      if (!name) return 'U';
      return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    }

    function setupColorPickers() {
      const primaryColor = $("fPrimary");
      const primaryText = $("fPrimaryText");
      const secondaryColor = $("fSecondary");
      const secondaryText = $("fSecondaryText");
      
      if (primaryColor && primaryText) {
        primaryColor.addEventListener('input', (e) => {
          primaryText.value = e.target.value;
          updateProfilePreview();
        });
        
        primaryText.addEventListener('input', (e) => {
          if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
            primaryColor.value = e.target.value;
            updateProfilePreview();
          }
        });
      }
      
      if (secondaryColor && secondaryText) {
        secondaryColor.addEventListener('input', (e) => {
          secondaryText.value = e.target.value;
          updateProfilePreview();
        });
        
        secondaryText.addEventListener('input', (e) => {
          if (e.target.value.match(/^#[0-9A-F]{6}$/i)) {
            secondaryColor.value = e.target.value;
            updateProfilePreview();
          }
        });
      }
      
      const brokerName = $("fBrokerName");
      const siteName = $("fSiteName");
      const bio = $("fBio");
      
      if (brokerName) brokerName.addEventListener('input', updateProfilePreview);
      if (siteName) siteName.addEventListener('input', updateProfilePreview);
      if (bio) bio.addEventListener('input', updateProfilePreview);
      
      // Foto do perfil
      const photoInput = $("fPhoto");
      if (photoInput) {
        photoInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const avatarImage = $("avatarImage");
              const avatarInitials = $("avatarInitials");
              if (avatarImage && avatarInitials) {
                avatarImage.src = event.target.result;
                avatarImage.style.display = 'block';
                avatarInitials.style.display = 'none';
              }
            };
            reader.onerror = () => {
              showToast('Erro ao carregar imagem', 'error');
            };
            reader.readAsDataURL(file);
          }
        });
      }
    }

    function updateProfilePreview() {
      try {
        const brokerName = $("fBrokerName").value || 'Seu Nome';
        const siteName = $("fSiteName").value || 'Seu Site Imobiliário';
        const bio = $("fBio").value || 'Vitrine de imóveis atualizada automaticamente pelo seu CRM. Atendimento rápido e profissional.';
        const primaryColor = $("fPrimary").value;
        const secondaryColor = $("fSecondary").value;
        
        const logoText2 = $("siteLogoText2");
        const heroTitle2 = $("siteHeroTitle2");
        const heroSub2 = $("siteHeroSub2");
        const userName = $("userName");
        const avatarInitials = $("avatarInitials");
        
        if (logoText2) logoText2.textContent = siteName;
        if (heroTitle2) heroTitle2.textContent = bio.split('.')[0] || bio;
        if (heroSub2) heroSub2.textContent = bio.length > 100 ? bio.substring(0, 100) + '...' : bio;
        
        if (userName) userName.textContent = brokerName;
        if (avatarInitials) avatarInitials.textContent = getInitials(brokerName);
        
        updateSiteColors();
      } catch (error) {
        console.error('Erro ao atualizar preview:', error);
      }
    }

    function saveProfile() {
      try {
        const brokerName = sanitizeInput($("fBrokerName").value.trim());
        const siteName = sanitizeInput($("fSiteName").value.trim());
        const bio = sanitizeInput($("fBio").value.trim());
        const primary = $("fPrimary").value;
        const secondary = $("fSecondary").value;
        const whatsapp = $("fWhatsapp").value.trim();
        
        if (!brokerName || !siteName || !bio || !primary || !secondary || !whatsapp) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        if (!primary.match(/^#[0-9A-F]{6}$/i) || !secondary.match(/^#[0-9A-F]{6}$/i)) {
          showToast('Cores inválidas! Use formato hexadecimal (#RRGGBB)', 'error');
          return;
        }
        
        const tenant = {
          broker_name: brokerName,
          creci: $("fCreci").value.trim(),
          whatsapp: whatsapp,
          site_name: siteName,
          primary_color: primary,
          secondary_color: secondary,
          bio: bio,
          updated_at: new Date().toISOString()
        };
        
        CRMState.tenant = { ...CRMState.tenant, ...tenant };
        
        const user = {
          name: brokerName,
          role: 'Corretor'
        };
        CRMState.user = { ...CRMState.user, ...user };
        
        saveToLocalStorage();
        
        showToast('Perfil salvo com sucesso!', 'success');
        updateSiteColors();
        renderSitePreview();
        updateDashboardMetrics();
        
      } catch (error) {
        console.error('Erro ao salvar perfil:', error);
        showToast('Erro ao salvar perfil', 'error');
      }
    }

    // 9. Calendar functions
    function renderCalendar() {
      try {
        const monthNames = [
          'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
          'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
        ];
        
        const currentMonthEl = $("currentMonth");
        if (currentMonthEl) {
          currentMonthEl.textContent = `${monthNames[CRMState.currentMonth]} ${CRMState.currentYear}`;
        }
        
        const firstDay = new Date(CRMState.currentYear, CRMState.currentMonth, 1);
        const lastDay = new Date(CRMState.currentYear, CRMState.currentMonth + 1, 0);
        const daysInMonth = lastDay.getDate();
        
        const calendarGrid = $("calendarGrid");
        if (!calendarGrid) return;
        
        // Remover dias antigos (mantendo os cabeçalhos)
        const dayCells = Array.from(calendarGrid.children).slice(7);
        dayCells.forEach(cell => cell.remove());
        
        const firstDayIndex = firstDay.getDay();
        
        // Dias vazios antes do primeiro dia do mês
        for (let i = 0; i < firstDayIndex; i++) {
          const emptyCell = document.createElement('div');
          emptyCell.className = 'calendar-day';
          emptyCell.style.visibility = 'hidden';
          calendarGrid.appendChild(emptyCell);
        }
        
        const today = new Date();
        const isCurrentMonth = today.getMonth() === CRMState.currentMonth && today.getFullYear() === CRMState.currentYear;
        
        // Dias do mês
        for (let day = 1; day <= daysInMonth; day++) {
          const dayCell = document.createElement('div');
          dayCell.className = 'calendar-day';
          dayCell.textContent = day;
          
          const cellDate = new Date(CRMState.currentYear, CRMState.currentMonth, day);
          const dateStr = cellDate.toISOString().split('T')[0];
          
          const dayAppointments = CRMState.appointments.filter(a => {
            const apptDate = new Date(a.start_at || Date.now());
            return apptDate.toISOString().split('T')[0] === dateStr;
          });
          
          if (dayAppointments.length > 0) {
            dayCell.classList.add('event');
            dayCell.title = `${dayAppointments.length} compromisso(s)`;
          }
          
          if (isCurrentMonth && day === today.getDate()) {
            dayCell.classList.add('today');
          }
          
          dayCell.onclick = () => showDayAppointments(dateStr);
          
          calendarGrid.appendChild(dayCell);
        }
        
        renderTodaysEvents();
      } catch (error) {
        console.error('Erro ao renderizar calendário:', error);
      }
    }

    function prevMonth() {
      if (CRMState.currentMonth === 0) {
        CRMState.currentMonth = 11;
        CRMState.currentYear--;
      } else {
        CRMState.currentMonth--;
      }
      renderCalendar();
    }

    function nextMonth() {
      if (CRMState.currentMonth === 11) {
        CRMState.currentMonth = 0;
        CRMState.currentYear++;
      } else {
        CRMState.currentMonth++;
      }
      renderCalendar();
    }

    function renderTodaysEvents() {
      const today = new Date().toISOString().split('T')[0];
      showDayAppointments(today);
    }

    function showDayAppointments(dateStr) {
      const container = $("todaysEvents");
      if (!container) return;
      
      try {
        const dayAppointments = CRMState.appointments.filter(a => {
          const apptDate = new Date(a.start_at || Date.now());
          return apptDate.toISOString().split('T')[0] === dateStr;
        }).sort((a, b) => new Date(a.start_at) - new Date(b.start_at));
        
        if (dayAppointments.length === 0) {
          container.innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--muted)">
              <i class="fa-solid fa-calendar-check" style="font-size:32px; margin-bottom:12px"></i>
              <div>Nenhum compromisso para este dia</div>
            </div>
          `;
        } else {
          container.innerHTML = dayAppointments.map(appt => {
            const lead = appt.client_id ? CRMState.leads.find(l => l.id == appt.client_id) : null;
            const property = appt.property_id ? CRMState.properties.find(p => p.id == appt.property_id) : null;
            
            return `
              <div class="event-item">
                <div>
                  <strong>${sanitizeInput(appt.title)}</strong>
                  <div style="font-size:12px; color:var(--muted)">
                    ${new Date(appt.start_at || Date.now()).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })} • ${appt.type}
                    ${lead ? ` • ${sanitizeInput(lead.name)}` : ''}
                    ${property ? ` • ${sanitizeInput(property.title.substring(0, 20))}...` : ''}
                  </div>
                </div>
                <button class="btn btn-outline" style="padding:6px 12px" onclick="editAppointment(${appt.id})">
                  <i class="fa-solid fa-pen"></i>
                </button>
              </div>
            `;
          }).join('');
        }
      } catch (error) {
        console.error('Erro ao mostrar compromissos:', error);
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--bad)">
            Erro ao carregar compromissos
          </div>
        `;
      }
    }

    function showScheduleModal() {
      showModal('modalNewSchedule');
      
      const today = new Date();
      $("scheduleDate").value = today.toISOString().split('T')[0];
      $("scheduleTime").value = `${today.getHours().toString().padStart(2, '0')}:${today.getMinutes().toString().padStart(2, '0')}`;
      
      populateClientSelect();
      populatePropertySelect();
      
      // Restaurar título e botão padrão
      const title = document.querySelector('#modalNewSchedule .modal-header strong');
      if (title) title.textContent = 'Agendar Novo Compromisso';
      
      const saveBtn = document.querySelector('#modalNewSchedule .modal-footer .btn-primary');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fa-solid fa-calendar-check"></i> <span>Agendar</span>';
        saveBtn.onclick = function() { saveSchedule(); };
      }
    }

    function populateClientSelect() {
      const select = $("scheduleClient");
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecione um lead...</option>' +
        CRMState.leads.map(lead => 
          `<option value="${lead.id}">${sanitizeInput(lead.name)} (${lead.phone})</option>`
        ).join('');
    }

    function populatePropertySelect() {
      const select = $("scheduleProperty");
      if (!select) return;
      
      select.innerHTML = '<option value="">Selecione um imóvel...</option>' +
        CRMState.properties.filter(p => p.status === 'active').map(prop => 
          `<option value="${prop.id}">${sanitizeInput(prop.title)}</option>`
        ).join('');
    }

    function saveSchedule() {
      try {
        const title = sanitizeInput($("scheduleTitle").value.trim());
        const type = $("scheduleType").value;
        const date = $("scheduleDate").value;
        const time = $("scheduleTime").value;
        
        if (!title || !type || !date || !time) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        const startAt = new Date(`${date}T${time}`);
        if (isNaN(startAt.getTime())) {
          showToast('Data/hora inválida!', 'error');
          return;
        }
        
        const appointment = {
          id: Date.now(),
          title,
          type,
          start_at: startAt.toISOString(),
          client_id: $("scheduleClient").value ? parseInt($("scheduleClient").value) : null,
          property_id: $("scheduleProperty").value ? parseInt($("scheduleProperty").value) : null,
          description: sanitizeInput($("scheduleDescription").value.trim()),
          reminder: $("scheduleReminder").value ? parseInt($("scheduleReminder").value) : null,
          status: $("scheduleStatus").value || 'scheduled',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
        
        CRMState.appointments.push(appointment);
        
        // Adicionar notificação
        CRMState.notifications.unshift({
          id: Date.now(),
          title: 'Novo compromisso agendado',
          message: `${title} - ${startAt.toLocaleDateString('pt-BR')} às ${startAt.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`,
          type: 'calendar',
          read: false,
          created_at: new Date().toISOString()
        });
        
        saveToLocalStorage();
        
        showToast('Compromisso agendado com sucesso!', 'success');
        closeModal('modalNewSchedule');
        renderCalendar();
        updateDashboardMetrics();
        
      } catch (error) {
        console.error('Erro ao salvar compromisso:', error);
        showToast('Erro ao agendar compromisso', 'error');
      }
    }

    function editAppointment(id) {
      const appointment = CRMState.appointments.find(a => a.id == id);
      if (!appointment) return;
      
      // Preencher formulário
      $("scheduleTitle").value = appointment.title;
      $("scheduleType").value = appointment.type;
      
      const startDate = new Date(appointment.start_at);
      $("scheduleDate").value = startDate.toISOString().split('T')[0];
      $("scheduleTime").value = `${startDate.getHours().toString().padStart(2, '0')}:${startDate.getMinutes().toString().padStart(2, '0')}`;
      
      populateClientSelect();
      populatePropertySelect();
      
      $("scheduleClient").value = appointment.client_id || '';
      $("scheduleProperty").value = appointment.property_id || '';
      $("scheduleDescription").value = appointment.description || '';
      $("scheduleReminder").value = appointment.reminder || '';
      $("scheduleStatus").value = appointment.status || 'scheduled';
      
      showModal('modalNewSchedule');
      
      // Alterar título do modal
      const title = document.querySelector('#modalNewSchedule .modal-header strong');
      if (title) title.textContent = 'Editar Compromisso';
      
      // Alterar botão de salvar
      const saveBtn = document.querySelector('#modalNewSchedule .modal-footer .btn-primary');
      if (saveBtn) {
        saveBtn.innerHTML = '<i class="fa-solid fa-save"></i> <span>Atualizar Compromisso</span>';
        saveBtn.onclick = function() { updateAppointment(id); };
      }
    }

    function updateAppointment(id) {
      try {
        const appointmentIndex = CRMState.appointments.findIndex(a => a.id == id);
        if (appointmentIndex === -1) {
          showToast('Compromisso não encontrado', 'error');
          return;
        }
        
        const title = sanitizeInput($("scheduleTitle").value.trim());
        const type = $("scheduleType").value;
        const date = $("scheduleDate").value;
        const time = $("scheduleTime").value;
        
        if (!title || !type || !date || !time) {
          showToast('Preencha todos os campos obrigatórios!', 'error');
          return;
        }
        
        const startAt = new Date(`${date}T${time}`);
        if (isNaN(startAt.getTime())) {
          showToast('Data/hora inválida!', 'error');
          return;
        }
        
        CRMState.appointments[appointmentIndex] = {
          ...CRMState.appointments[appointmentIndex],
          title,
          type,
          start_at: startAt.toISOString(),
          client_id: $("scheduleClient").value ? parseInt($("scheduleClient").value) : null,
          property_id: $("scheduleProperty").value ? parseInt($("scheduleProperty").value) : null,
          description: sanitizeInput($("scheduleDescription").value.trim()),
          reminder: $("scheduleReminder").value ? parseInt($("scheduleReminder").value) : null,
          status: $("scheduleStatus").value || 'scheduled',
          updated_at: new Date().toISOString()
        };
        
        saveToLocalStorage();
        
        showToast('Compromisso atualizado com sucesso!', 'success');
        closeModal('modalNewSchedule');
        renderCalendar();
        
      } catch (error) {
        console.error('Erro ao atualizar compromisso:', error);
        showToast('Erro ao atualizar compromisso', 'error');
      }
    }

    // 10. Notifications functions
    function showNotificationsModal() {
      showModal('modalNotifications');
      renderNotifications();
    }

    function renderNotifications() {
      const container = $("notificationsList");
      if (!container) return;
      
      try {
        if (CRMState.notifications.length === 0) {
          container.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--muted)">
              <i class="fa-regular fa-bell" style="font-size:48px; margin-bottom:16px"></i>
              <div>Nenhuma notificação</div>
            </div>
          `;
          return;
        }
        
        container.innerHTML = CRMState.notifications.map(notif => `
          <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationRead(${notif.id})">
            <div class="notification-icon">
              <i class="fa-solid ${getNotificationIcon(notif.type)}"></i>
            </div>
            <div class="notification-content">
              <strong>${sanitizeInput(notif.title)}</strong>
              <p>${sanitizeInput(notif.message)}</p>
              <div class="notification-time">
                ${formatRelativeTime(new Date(notif.created_at))}
              </div>
            </div>
            ${!notif.read ? '<span class="badge" style="background:var(--primary);color:white;border-radius:50%;width:8px;height:8px;"></span>' : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Erro ao renderizar notificações:', error);
        container.innerHTML = `
          <div style="text-align:center; padding:20px; color:var(--bad)">
            Erro ao carregar notificações
          </div>
        `;
      }
    }

    function getNotificationIcon(type) {
      const icons = {
        'property': 'fa-house',
        'lead': 'fa-user',
        'calendar': 'fa-calendar',
        'message': 'fa-message',
        'system': 'fa-cog'
      };
      return icons[type] || 'fa-bell';
    }

    function formatRelativeTime(date) {
      try {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        
        if (diffMins < 1) return 'Agora';
        if (diffMins < 60) return `Há ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
        if (diffHours < 24) return `Há ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
        if (diffDays < 7) return `Há ${diffDays} dia${diffDays > 1 ? 's' : ''}`;
        return date.toLocaleDateString('pt-BR');
      } catch (e) {
        return '';
      }
    }

    function markNotificationRead(id) {
      const notifIndex = CRMState.notifications.findIndex(n => n.id == id);
      if (notifIndex !== -1) {
        CRMState.notifications[notifIndex].read = true;
        saveToLocalStorage();
        renderNotifications();
        updateDashboardMetrics();
      }
    }

    function markAllNotificationsRead() {
      CRMState.notifications.forEach(notif => notif.read = true);
      saveToLocalStorage();
      renderNotifications();
      updateDashboardMetrics();
      showToast('Todas as notificações marcadas como lidas', 'success');
    }

    // 11. Reports functions
    function renderReports() {
      renderMonthlyReportChart();
      updateReportMetrics();
    }

    function renderMonthlyReportChart() {
      const ctx = $("monthlyReportChart");
      if (!ctx) return;
      
      // Destruir gráfico anterior se existir
      if (window.monthlyReportChart && typeof window.monthlyReportChart.destroy === 'function') {
        try {
          window.monthlyReportChart.destroy();
        } catch (e) {
          console.warn('Erro ao destruir gráfico anterior:', e);
        }
      }
      
      try {
        // Gerar dados para os últimos 6 meses
        const labels = [];
        const leadsData = [];
        const propertiesData = [];
        
        const now = new Date();
        for (let i = 5; i >= 0; i--) {
          const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const monthName = month.toLocaleDateString('pt-BR', { month: 'short' });
          labels.push(monthName);
          
          // Contar leads deste mês
          const monthLeads = CRMState.leads.filter(lead => {
            const leadDate = new Date(lead.created_at);
            return leadDate.getMonth() === month.getMonth() && leadDate.getFullYear() === month.getFullYear();
          }).length;
          
          // Contar propriedades deste mês
          const monthProperties = CRMState.properties.filter(prop => {
            const propDate = new Date(prop.created_at);
            return propDate.getMonth() === month.getMonth() && propDate.getFullYear() === month.getFullYear();
          }).length;
          
          leadsData.push(monthLeads);
          propertiesData.push(monthProperties);
        }
        
        window.monthlyReportChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Leads',
                data: leadsData,
                backgroundColor: CRMState.tenant?.primary_color || '#2563eb',
                borderRadius: 6,
                barPercentage: 0.6
              },
              {
                label: 'Imóveis',
                data: propertiesData,
                backgroundColor: CRMState.tenant?.secondary_color || '#0ea5e9',
                borderRadius: 6,
                barPercentage: 0.6
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Erro ao criar gráfico de relatório:', error);
      }
    }

    function updateReportMetrics() {
      try {
        // Taxa de resposta
        const respondedLeads = CRMState.leads.filter(l => l.stage !== 'new').length;
        const responseRate = CRMState.leads.length > 0 ? 
          Math.round((respondedLeads / CRMState.leads.length) * 100) : 0;
        
        // Dias para conversão
        const convertedLeads = CRMState.leads.filter(l => l.stage === 'converted');
        const avgConversionDays = convertedLeads.length > 0 ? 
          Math.round(convertedLeads.reduce((sum, lead) => {
            const created = new Date(lead.created_at);
            const converted = new Date(lead.last_contact || lead.created_at);
            const diffTime = Math.abs(converted - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return sum + diffDays;
          }, 0) / convertedLeads.length) : 0;
        
        const responseRateEl = $("responseRate");
        const conversionDaysEl = $("conversionDays");
        
        if (responseRateEl) responseRateEl.textContent = `${responseRate}%`;
        if (conversionDaysEl) conversionDaysEl.textContent = `${avgConversionDays} dias`;
      } catch (error) {
        console.error('Erro ao atualizar métricas do relatório:', error);
      }
    }

    function generateReportPDF() {
      showToast('Gerando relatório PDF...', 'info');
      
      const reportData = {
        date: new Date().toLocaleDateString('pt-BR'),
        brokerName: CRMState.tenant?.broker_name || 'Não informado',
        totalProperties: CRMState.properties.length,
        totalLeads: CRMState.leads.length,
        activeProperties: CRMState.properties.filter(p => p.status === 'active').length,
        convertedLeads: CRMState.leads.filter(l => l.stage === 'converted').length
      };
      
      console.log('Dados do relatório:', reportData);
      
      // Simular geração de PDF
      setTimeout(() => {
        showToast('Relatório PDF gerado com sucesso!', 'success');
      }, 1500);
    }

    function generateMonthlyReport() {
      renderMonthlyReportChart();
      showToast('Gráfico mensal atualizado!', 'success');
    }

    function exportReportData() {
      try {
        const data = {
          properties: CRMState.properties,
          leads: CRMState.leads,
          appointments: CRMState.appointments,
          generated_at: new Date().toISOString()
        };
        
        const dataStr = JSON.stringify(data, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', `relatorio_imobi_pro_${new Date().toISOString().split('T')[0]}.json`);
        document.body.appendChild(linkElement);
        linkElement.click();
        document.body.removeChild(linkElement);
        
        showToast('Dados exportados com sucesso!', 'success');
      } catch (error) {
        console.error('Erro ao exportar dados:', error);
        showToast('Erro ao exportar dados', 'error');
      }
    }

    function printReport() {
      showToast('Preparando para impressão...', 'info');
      setTimeout(() => {
        window.print();
      }, 500);
    }

    // 12. Storage functions
    function saveToLocalStorage() {
      try {
        const data = {
          tenant: CRMState.tenant,
          user: CRMState.user,
          properties: CRMState.properties,
          leads: CRMState.leads,
          appointments: CRMState.appointments,
          notifications: CRMState.notifications,
          _onboardingCompleted: CRMState._onboardingCompleted,
          lang: CRMState.lang
        };
        
        localStorage.setItem('imobipro_crm', JSON.stringify(data));
        
        // Backup automático
        sessionStorage.setItem('imobipro_backup', JSON.stringify(data));
      } catch (error) {
        console.error('Erro ao salvar no localStorage:', error);
        showToast('Erro ao salvar dados localmente', 'error');
      }
    }

    function loadFromLocalStorage() {
      try {
        const data = localStorage.getItem('imobipro_crm');
        if (!data) {
          loadDemoData();
          return;
        }
        
        const parsed = JSON.parse(data);
        
        CRMState.tenant = parsed.tenant || CRMState.tenant;
        CRMState.user = parsed.user || CRMState.user;
        CRMState.properties = parsed.properties || CRMState.properties;
        CRMState.leads = parsed.leads || CRMState.leads;
        CRMState.appointments = parsed.appointments || CRMState.appointments;
        CRMState.notifications = parsed.notifications || CRMState.notifications;
        CRMState._onboardingCompleted = parsed._onboardingCompleted || CRMState._onboardingCompleted;
        CRMState.lang = parsed.lang || 'pt';
        
      } catch (error) {
        console.error('Erro ao carregar dados:', error);
        
        // Tentar restaurar do backup
        try {
          const backup = sessionStorage.getItem('imobipro_backup');
          if (backup) {
            const parsed = JSON.parse(backup);
            CRMState.tenant = parsed.tenant;
            CRMState.user = parsed.user;
            CRMState.properties = parsed.properties || [];
            CRMState.leads = parsed.leads || [];
            CRMState.appointments = parsed.appointments || [];
            CRMState.notifications = parsed.notifications || [];
            CRMState._onboardingCompleted = parsed._onboardingCompleted || false;
            CRMState.lang = parsed.lang || 'pt';
            showToast('Dados restaurados do backup', 'info');
          } else {
            loadDemoData();
          }
        } catch (backupError) {
          console.error('Erro ao restaurar backup:', backupError);
          loadDemoData();
        }
      }
    }

    function loadDemoData() {
      // Dados demo para demonstração
      CRMState.user = {
        id: 1,
        name: 'Gabriel Nunes',
        email: 'demo@imobipro.com',
        role: 'Corretor',
        created_at: new Date().toISOString()
      };
      
      CRMState.tenant = {
        broker_name: 'Gabriel Nunes',
        site_name: 'ImobiPro Demo',
        primary_color: '#2563eb',
        secondary_color: '#0ea5e9',
        bio: 'Seja bem-vindo ao meu site de imóveis! Encontre o lar dos seus sonhos com segurança e agilidade.',
        whatsapp: '83999999999',
        creci: '123456'
      };
      
      // Imóveis demo
      CRMState.properties = [
        {
          id: 1,
          title: 'Apartamento 2 quartos no Centro',
          type: 'apartment',
          address: 'Rua das Flores, 123',
          city: 'João Pessoa',
          price: 450000,
          area: 85,
          bedrooms: 2,
          bathrooms: 2,
          description: 'Apartamento bem localizado, próximo a comércios e escolas. Reformado recentemente.',
          images: [],
          status: 'active',
          visits: 12,
          created_at: new Date(Date.now() - 86400000 * 5).toISOString(),
          updated_at: new Date().toISOString()
        },
        {
          id: 2,
          title: 'Casa com piscina no Bessa',
          type: 'house',
          address: 'Av. Cabo Branco, 456',
          city: 'João Pessoa',
          price: 750000,
          area: 180,
          bedrooms: 3,
          bathrooms: 3,
          description: 'Casa espaçosa com piscina, jardim e garagem para 2 carros.',
          images: [],
          status: 'active',
          visits: 8,
          created_at: new Date(Date.now() - 86400000 * 3).toISOString(),
          updated_at: new Date().toISOString()
        }
      ];
      
      // Leads demo
      CRMState.leads = [
        {
          id: 1,
          name: 'Ana Silva',
          email: 'ana@email.com',
          phone: '(83) 98888-8888',
          source: 'site',
          interest: 'apartment',
          budget: 500000,
          notes: 'Interessada em apartamentos próximos ao trabalho',
          stage: 'negotiation',
          created_at: new Date(Date.now() - 86400000 * 2).toISOString(),
          last_contact: new Date().toISOString()
        },
        {
          id: 2,
          name: 'Carlos Santos',
          email: 'carlos@email.com',
          phone: '(83) 97777-7777',
          source: 'whatsapp',
          interest: 'house',
          budget: 800000,
          notes: 'Procura casa com piscina',
          stage: 'contacted',
          created_at: new Date(Date.now() - 86400000 * 1).toISOString(),
          last_contact: new Date().toISOString()
        }
      ];
      
      // Compromissos demo
      CRMState.appointments = [
        {
          id: 1,
          title: 'Visita ao apartamento do Centro',
          type: 'visit',
          start_at: new Date(Date.now() + 86400000 * 2).toISOString(),
          client_id: 1,
          property_id: 1,
          description: 'Mostrar apartamento para Ana Silva',
          status: 'scheduled',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }
      ];
      
      // Notificações demo
      CRMState.notifications = [
        {
          id: 1,
          title: 'Lead novo cadastrado',
          message: 'Ana Silva se interessou por apartamento',
          type: 'lead',
          read: false,
          created_at: new Date(Date.now() - 3600000).toISOString()
        }
      ];
    }

    // 13. Utility functions
    function showSupport() {
      showToast('Abrindo suporte via WhatsApp...', 'info');
      window.open('https://wa.me/5500000000000?text=Olá, preciso de ajuda com o CRM ImobiPro', '_blank');
    }

    function showDocs() {
      showToast('Abrindo documentação...', 'info');
      window.open('https://docs.imobipro.app', '_blank');
    }

    function logout() {
      if (confirm('Tem certeza que deseja sair?')) {
        showToast('Saindo do sistema...', 'info');
        setTimeout(() => {
          localStorage.removeItem('imobipro_crm');
          window.location.href = 'login.html';
        }, 1000);
      }
    }

    function connectWhatsApp() {
      showToast('Conectando WhatsApp Business API...', 'info');
    }

    function generateReport() {
      showToast('Gerando relatório...', 'info');
      switchView('reports');
    }

    function completeOnboarding() {
      CRMState._onboardingCompleted = true;
      saveToLocalStorage();
      closeModal('modalOnboarding');
      showToast('Onboarding concluído! Bem-vindo ao CRM ImobiPro.', 'success');
    }

    // 14. Initialize
    function initializeCRM() {
      loadFromLocalStorage();
      
      // Configurar idioma
      const langSelect = $("lang");
      if (langSelect) {
        langSelect.value = CRMState.lang;
      }
      
      // Atualizar perfil
      loadProfileData();
      
      // Inicializar métricas
      updateDashboardMetrics();
      renderProperties();
      renderLeads();
      renderSitePreview();
      renderCalendar();
      
      // Atualizar progresso do plano
      updatePlanProgress();
      
      if (!CRMState._onboardingCompleted) {
        setTimeout(() => {
          if ($('modalOnboarding')) {
            showModal('modalOnboarding');
          }
        }, 1000);
      }
      
      showToast('CRM ImobiPro carregado com sucesso!', 'success');
    }

    function updatePlanProgress() {
      try {
        const used = CRMState.properties.length + CRMState.leads.length;
        const limit = 100; // Limite do plano demo
        const percentage = Math.min(Math.round((used / limit) * 100), 100);
        
        const progressBar = $("planProgress");
        const percentageEl = $("planPercentage");
        const renewalEl = $("planRenewal");
        
        if (progressBar) progressBar.style.width = `${percentage}%`;
        if (percentageEl) percentageEl.textContent = percentage;
        
        // Data de renovação (30 dias a partir de hoje)
        if (renewalEl) {
          const renewalDate = new Date(Date.now() + 30 * 86400000);
          renewalEl.textContent = `Renova: ${renewalDate.toLocaleDateString('pt-BR')}`;
        }
      } catch (error) {
        console.error('Erro ao atualizar progresso do plano:', error);
      }
    }

    // 15. Event Listeners e correções finais
    function setupGlobalEventListeners() {
      // Language selector
      const langSelect = $("lang");
      if (langSelect) {
        langSelect.addEventListener('change', (e) => {
          CRMState.lang = e.target.value;
          saveToLocalStorage();
          showToast(`Idioma alterado para ${e.target.value === 'pt' ? 'Português' : e.target.value === 'en' ? 'Inglês' : 'Espanhol'}`, 'info');
        });
      }
      
      // Global search com debounce
      const globalSearch = $("globalSearch");
      if (globalSearch) {
        globalSearch.addEventListener('input', (e) => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const searchTerm = e.target.value.toLowerCase().trim();
            if (searchTerm.length > 2) {
              performSearch(searchTerm);
            }
          }, 300);
        });
      }
      
      // Photo upload area drag and drop
      const photoUploadArea = $("photoUploadArea");
      if (photoUploadArea) {
        photoUploadArea.addEventListener('dragover', (e) => {
          e.preventDefault();
          photoUploadArea.style.borderColor = 'var(--primary)';
          photoUploadArea.style.background = 'rgba(37, 99, 235, 0.05)';
        });
        
        photoUploadArea.addEventListener('dragleave', () => {
          photoUploadArea.style.borderColor = '';
          photoUploadArea.style.background = '';
        });
        
        photoUploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          photoUploadArea.style.borderColor = '';
          photoUploadArea.style.background = '';
          
          const files = Array.from(e.dataTransfer.files);
          handlePropertyPhotos({ target: { files } });
        });
      }
      
      // Fechar modal com ESC
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const openModals = document.querySelectorAll('.modal-backdrop[style*="display: flex"]');
          if (openModals.length > 0) {
            const modalId = openModals[0].id;
            closeModal(modalId);
          }
        }
      });
      
      // Fechar modal ao clicar no backdrop
      document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal.id);
          }
        });
      });
      
      // Validação em tempo real
      setupRealTimeValidation();
    }

    function performSearch(searchTerm) {
      showToast(`Buscando por: ${searchTerm}`, 'info');
      // Implementar busca real aqui
    }

    function setupRealTimeValidation() {
      // Validar email
      const leadEmail = $("leadEmail");
      if (leadEmail) {
        leadEmail.addEventListener('blur', (e) => {
          const email = e.target.value.trim();
          if (email && !isValidEmail(email)) {
            showToast('Email inválido', 'warning');
            e.target.classList.add('input-error');
          } else {
            e.target.classList.remove('input-error');
          }
        });
      }
      
      // Validar telefone
      const leadPhone = $("leadPhone");
      if (leadPhone) {
        leadPhone.addEventListener('blur', (e) => {
          const phone = e.target.value.trim();
          if (phone) {
            e.target.value = formatPhone(phone);
          }
        });
      }
      
      // Validar valor
      const propertyPrice = $("propertyPrice");
      if (propertyPrice) {
        propertyPrice.addEventListener('blur', (e) => {
          const value = parseFloat(e.target.value);
          if (isNaN(value) || value <= 0) {
            showToast('Valor deve ser maior que zero', 'warning');
            e.target.classList.add('input-error');
          } else {
            e.target.classList.remove('input-error');
          }
        });
      }
    }

    // 16. Messages functions (placeholders)
    function sendMessage() {
      showToast('Enviando mensagem...', 'info');
    }

    // 17. Cleanup function
    function cleanup() {
      // Destruir gráficos
      if (window.performanceChart && typeof window.performanceChart.destroy === 'function') {
        window.performanceChart.destroy();
      }
      if (window.monthlyReportChart && typeof window.monthlyReportChart.destroy === 'function') {
        window.monthlyReportChart.destroy();
      }
      
      // Limpar timeouts
      if (searchTimeout) {
        clearTimeout(searchTimeout);
      }
    }

    // Inicializar quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
      initializeCRM();
      setupGlobalEventListeners();
      
      // Cleanup antes de sair
      window.addEventListener('beforeunload', cleanup);
    });
  </script>

<!-- ===== Etapa 7: Plano efetivo (v_effective_plan) + Upgrade (injetado, sem alterar layout) ===== -->
<script>
(function () {
  function getSupabaseClient() {
    try {
      if (window.supabaseClient) return window.supabaseClient;
      if (window.sb) return window.sb;
      if (window.supabase && window.supabase.auth && window.supabase.from) return window.supabase;
      if (typeof supabase !== "undefined" && supabase && supabase.auth && supabase.from) return supabase;
    } catch (e) {}
    return null;
  }

  function titleCasePlan(p) {
    if (!p) return "";
    const map = { basico: "Básico", profissional: "Profissional", premium: "Premium" };
    const k = String(p).toLowerCase();
    return map[k] || (k.charAt(0).toUpperCase() + k.slice(1));
  }

  function formatDateBR(iso) {
    try {
      const d = new Date(iso);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString("pt-BR");
    } catch (e) { return ""; }
  }

  function findPlanCard() {
    const all = Array.from(document.querySelectorAll("body *"));

    // 1) procurar "Renova:"
    const renovaEl = all.find(el => (el.childElementCount === 0) && /renova\s*:/i.test(el.textContent || ""));
    if (renovaEl) {
      let node = renovaEl;
      for (let i = 0; i < 10 && node; i++) {
        const txt = (node.textContent || "");
        if (/plano/i.test(txt) && (/renova\s*:/i.test(txt) || /utilizado/i.test(txt))) return node;
        node = node.parentElement;
      }
      return renovaEl.parentElement || renovaEl;
    }

    // 2) procurar "Plano" + "ATIVO"
    const candidate = all.find(el => {
      const t = (el.textContent || "").trim();
      return /plano/i.test(t) && /\bativo\b/i.test(t) && (t.length < 600);
    });
    if (candidate) return candidate;

    // 3) fallback: sidebar
    return document.querySelector("aside, nav") || null;
  }

  function ensureUpgradeButton(container) {
    if (!container) return null;
    let btn = container.querySelector('[data-upgrade-btn="1"]');
    if (btn) return btn;

    btn = document.createElement("a");
    btn.href = "/checkout.html?plan=premium";
    btn.setAttribute("data-upgrade-btn", "1");
    btn.textContent = "Fazer upgrade";

    // estilo seguro e discreto
    btn.style.display = "inline-flex";
    btn.style.alignItems = "center";
    btn.style.justifyContent = "center";
    btn.style.gap = "8px";
    btn.style.marginTop = "10px";
    btn.style.padding = "10px 12px";
    btn.style.borderRadius = "12px";
    btn.style.fontWeight = "700";
    btn.style.textDecoration = "none";
    btn.style.border = "1px solid rgba(255,255,255,.35)";
    btn.style.background = "rgba(255,255,255,.15)";
    btn.style.color = "inherit";
    btn.style.cursor = "pointer";

    container.appendChild(btn);
    return btn;
  }

  function injectPlanMeta(container) {
    if (!container) return null;

    let meta = container.querySelector('[data-plan-meta="1"]');
    if (!meta) {
      meta = document.createElement("div");
      meta.setAttribute("data-plan-meta", "1");
      meta.style.marginTop = "8px";
      meta.style.fontSize = "12px";
      meta.style.lineHeight = "1.25";
      meta.style.opacity = "0.95";
      meta.style.display = "grid";
      meta.style.gap = "4px";

      // tenta inserir próximo ao título do plano
      const leafs = Array.from(container.querySelectorAll("*")).filter(el => el.childElementCount === 0);
      const planLeaf = leafs.find(el => /^plano\s+/i.test((el.textContent||"").trim()));
      if (planLeaf && planLeaf.parentElement) planLeaf.parentElement.appendChild(meta);
      else container.appendChild(meta);
    }
    return meta;
  }

  async function loadEffectivePlan() {
    const sb = getSupabaseClient();
    if (!sb) return;

    const userRes = await sb.auth.getUser();
    const user = userRes && userRes.data ? userRes.data.user : null;
    if (!user) return;

    const { data, error } = await sb
      .from("v_effective_plan")
      .select("contracted_plan,effective_plan,premium_trial_until,status,created_at,tenant_id")
      .eq("user_id", user.id)
      .order("created_at", { ascending: false })
      .limit(1)
      .maybeSingle();

    if (error || !data) {
      console.warn("Plano: não foi possível carregar v_effective_plan.", error);
      return;
    }

    const contracted = String(data.contracted_plan || "").toLowerCase();
    const effective = String(data.effective_plan || "").toLowerCase();
    const until = data.premium_trial_until;

    // Expor globalmente (bloqueios/limites)
    window.EFFECTIVE_PLAN = effective || contracted || "basico";
    window.CONTRACTED_PLAN = contracted || "basico";
    window.PREMIUM_TRIAL_UNTIL = until || null;

    // UI
    const card = findPlanCard();
    if (!card) return;

    const leafs = Array.from(card.querySelectorAll("*")).filter(el => el.childElementCount === 0);
    const planTitleEl = leafs.find(el => /^plano\s+/i.test((el.textContent||"").trim()));
    if (planTitleEl) planTitleEl.textContent = `Plano ${titleCasePlan(contracted || effective)}`;

    const renovaLeaf = leafs.find(el => /renova\s*:/i.test(el.textContent||""));
    const isTrial = !!(until && effective === "premium" && contracted !== "premium");

    if (renovaLeaf && isTrial) {
      renovaLeaf.textContent = `Premium até: ${formatDateBR(until)}`;
    }

    const meta = injectPlanMeta(card);
    if (meta) {
      meta.innerHTML = `
        <div><strong>Contratado:</strong> ${titleCasePlan(contracted || "—")}</div>
        <div><strong>Ativo:</strong> ${titleCasePlan(effective || contracted || "—")}${isTrial ? ` <span style="opacity:.9">(bônus)</span>` : ""}</div>
        ${isTrial ? `<div><strong>Premium até:</strong> ${formatDateBR(until)}</div>` : ``}
      `;
    }

    const btn = ensureUpgradeButton(card);
    if (btn) {
      btn.style.display = (contracted !== "premium") ? "inline-flex" : "none";
      btn.href = "/checkout.html?plan=premium";
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    loadEffectivePlan();
    let tries = 0;
    const t = setInterval(() => {
      tries++;
      if (window.EFFECTIVE_PLAN) { clearInterval(t); return; }
      loadEffectivePlan();
      if (tries >= 10) clearInterval(t);
    }, 1200);
  });
})();
</script>
  <script type="module" src="./app.js"></script>
</body>
</html>
